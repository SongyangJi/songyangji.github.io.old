<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="JsyBlog">
<meta property="og:url" content="http://example.com/page/10/index.html">
<meta property="og:site_name" content="JsyBlog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="SongyangJi">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/10/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/10/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>JsyBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">JsyBlog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">SongyangJi</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">246</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">109</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/14/Homebrew%E6%9B%B4%E6%8D%A2%E9%95%9C%E5%83%8F%E6%BA%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SongyangJi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JsyBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | JsyBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/14/Homebrew%E6%9B%B4%E6%8D%A2%E9%95%9C%E5%83%8F%E6%BA%90/" class="post-title-link" itemprop="url">Homebrew更换镜像源</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-14 02:59:24 / 修改时间：02:59:40" itemprop="dateCreated datePublished" datetime="2022-05-14T02:59:24+08:00">2022-05-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="替换brew-git"><a href="#替换brew-git" class="headerlink" title="替换brew.git"></a>替换brew.git</h1><p>cd “$(brew –repo)”<br>git remote set-url origin <a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/homebrew/brew.git">https://mirrors.aliyun.com/homebrew/brew.git</a></p>
<h1 id="替换homebrew-core-git"><a href="#替换homebrew-core-git" class="headerlink" title="替换homebrew-core.git"></a>替换homebrew-core.git</h1><p>cd “$(brew –repo)&#x2F;Library&#x2F;Taps&#x2F;homebrew&#x2F;homebrew-core”<br>git remote set-url origin <a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/homebrew/homebrew-core.git">https://mirrors.aliyun.com/homebrew/homebrew-core.git</a></p>
<h1 id="替换homebrew-bottles访问地址"><a href="#替换homebrew-bottles访问地址" class="headerlink" title="替换homebrew-bottles访问地址"></a>替换homebrew-bottles访问地址</h1><p>echo ‘export HOMEBREW_BOTTLE_DOMAIN&#x3D;<a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/homebrew/homebrew-bottles">https://mirrors.aliyun.com/homebrew/homebrew-bottles</a>‘ &gt;&gt; ~&#x2F;.zprofile<br>source ~&#x2F;.zprofile</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/13/Jenkins-API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SongyangJi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JsyBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | JsyBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/13/Jenkins-API/" class="post-title-link" itemprop="url">Jenkins-API</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-13 02:43:18" itemprop="dateCreated datePublished" datetime="2022-05-13T02:43:18+08:00">2022-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-07 15:20:39" itemprop="dateModified" datetime="2022-06-07T15:20:39+08:00">2022-06-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Jenkins/" itemprop="url" rel="index"><span itemprop="name">Jenkins</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h1><p>Many objects of Jenkins provide the remote access API. They are available at <code>/.../api/</code> where “…” portion is the object for which you’d like to access.</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="http://211.87.224.233:18080/api/xml">XML API</a></p>
<p>Access data exposed in <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/">HTML</a> as XML for machine consumption. <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/api/schema">Schema</a> is also available.You can also specify optional XPath to control the fragment you’d like to obtain (but see <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/api/#tree">below</a>). For example, <code>../api/xml?xpath=/*/*[0]</code>.For XPath that matches multiple nodes, you need to also specify the “wrapper” query parameter to specify the name of the root XML element to be create so that the resulting XML becomes well-formed.Similarly <code>exclude</code> query parameter can be used to exclude nodes that match the given XPath from the result. This is useful for trimming down the amount of data you fetch (but again see <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/api/#tree">below</a>). This query parameter can be specified multiple times.XPath filtering is powerful, and you can have it only return a very small data, but note that the server still has to build a full DOM of the raw data, which could cause a large memory spike. To avoid overloading the server, consider using the <code>tree</code> parameter, or use the <code>xpath</code> parameter in conjunction with the <code>tree</code> parameter. When used together, the result of the <code>tree</code> parameter filtering is built into DOM, then the XPath is applied to compute the final return value. In this way, you can often substantially reduce the size of DOM built in memory.</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://211.87.224.233:18080/api/json?pretty=true">JSON API</a></p>
<p>Access the same data as JSON for JavaScript-based access. <code>tree</code> may be used.</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://211.87.224.233:18080/api/python?pretty=true">Python API</a></p>
<p>Access the same data as Python for Python clients. This can be parsed into Python objects as <code>ast.literal_eval(urllib.urlopen(&quot;...&quot;).read())</code> and the resulting object tree is identical to that of JSON.</p>
</li>
</ul>
<p>For more information about remote API in Jenkins, see <a target="_blank" rel="noopener" href="https://www.jenkins.io/redirect/remote-api">the documentation</a>.</p>
<h2 id="Controlling-the-amount-of-data-you-fetch"><a href="#Controlling-the-amount-of-data-you-fetch" class="headerlink" title="Controlling the amount of data you fetch"></a>Controlling the amount of data you fetch</h2><p>The <code>tree</code> query parameter allows you to explicitly specify and retrieve only the information you are looking for, by using an XPath-ish path expression. The value should be a list of property names to include, with sub-properties inside square braces. Try [tree&#x3D;jobs[name],views[name,jobs[name]]](<a target="_blank" rel="noopener" href="http://211.87.224.233:18080/api/xml?tree=jobs%5Bname%5D,views%5Bname,jobs%5Bname%5D%5D">http://211.87.224.233:18080/api/xml?tree=jobs[name],views[name,jobs[name]]</a>) to see just a list of jobs (only giving the name) and views (giving the name and jobs they contain). <strong>Note</strong>: for array-type properties (such as <code>jobs</code> in this example), the name must be given in the original plural, not in the singular as the element would appear in XML (<code>&lt;job&gt;</code>). This will be more natural for e.g. [json?tree&#x3D;jobs<a target="_blank" rel="noopener" href="http://211.87.224.233:18080/api/json?tree=jobs%5Bname%5D">name]</a> anyway: the JSON writer does not do plural-to-singular mangling because arrays are represented explicitly.</p>
<p>For array-type properties, a range specifier is supported. For example, <code>tree=jobs[name]&#123;0,10&#125;</code> would retrieve the name of the first 10 jobs. The range specifier has the following variants:</p>
<ul>
<li><strong>{M,N}</strong>: From the M-th element (inclusive) to the N-th element (exclusive).</li>
<li><strong>{M,}</strong>: From the M-th element (inclusive) to the end.</li>
<li><strong>{,N}</strong>: From the first element (inclusive) to the N-th element (exclusive). The same as {0,N}.</li>
<li><strong>{N}</strong>: Just retrieve the N-th element. The same as {N,N+1}.</li>
</ul>
<p>Another way to retrieve more data is to use the <code>depth=N</code> query parameter. This retrieves all the data up to the specified depth. Compare <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/api/xml">depth&#x3D;0</a> and <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/api/xml?depth=1">depth&#x3D;1</a> and see what the difference is for yourself. Also note that data created by a smaller depth value is always a subset of the data created by a bigger depth value.</p>
<p>Because of the size of the data, the <code>depth</code> parameter should really be only used to explore what data Jenkins can return. Once you identify the data you want to retrieve, you can then come up with the <code>tree</code> parameter to exactly specify the data you need.</p>
<h2 id="Create-Job"><a href="#Create-Job" class="headerlink" title="Create Job"></a>Create Job</h2><p>要创建新的Job，请使用查询参数发布config.xml到此URL（http:&#x2F;&#x2F;{jenkinsUrl}&#x2F;createItem ），带上请求参数<code>name=*JOBNAME*</code>，请求头上带着<code>Content-Type: application/xml</code> 。</p>
<p>如果创建成功，您将获得 200 状态码，如果创建失败，您将获得 4xx&#x2F;5xx 码。</p>
<p><code>config.xml</code>是 Jenkins 用于将Job（无论是FreeStyle、Pipeline，还是其他类型的）存储在文件系统中的文件格式，因此可以在 Jenkins 主目录中查看它们的示例，或者通过直接从<code>/job/*JOBNAME*/config.xml</code>查询已经存在的job的xml定义。</p>
<h2 id="Copy-Job"><a href="#Copy-Job" class="headerlink" title="Copy Job"></a>Copy Job</h2><p>为了复制一个已有的Job，发送Post请求到此URL（http:&#x2F;&#x2F;{jenkinsUrl}&#x2F;createItem ），带上请求参数<code>name=*NEWJOBNAME*&amp;mode=copy&amp;from=*FROMJOBNAME*</code>。</p>
<h2 id="Build-Queue"><a href="#Build-Queue" class="headerlink" title="Build Queue"></a>Build Queue</h2><p>Build queue has <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/queue/api/">its own separate API</a>.</p>
<h2 id="Load-Statistics"><a href="#Load-Statistics" class="headerlink" title="Load Statistics"></a>Load Statistics</h2><p>Overall load statistics of Jenkins has <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/overallLoad/api/">its own separate API</a>.</p>
<h2 id="Restarting-Jenkins"><a href="#Restarting-Jenkins" class="headerlink" title="Restarting Jenkins"></a>Restarting Jenkins</h2><p>Jenkins will enter into the “quiet down” mode by sending a POST request with optional <code>reason</code> query parameter to <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/quietDown">this URL</a>. You can also send another request to this URL to update the reason. You can cancel this mode by sending a POST request to <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/cancelQuietDown">this URL</a>. On environments where Jenkins can restart itself (such as when Jenkins is installed as a Windows service), POSTing to <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/restart">this URL</a> will start the restart sequence, or <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/safeRestart">this URL</a> to restart once no jobs are running. All these URLs need Overall&#x2F;Manage permission (typically granted via Overall&#x2F;Administer).</p>
<blockquote>
<p>参考文档</p>
<p><a target="_blank" rel="noopener" href="https://ci.jenkins.io/api/">https://ci.jenkins.io/api/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jenkins.io/doc/book/using/remote-access-api/">https://www.jenkins.io/doc/book/using/remote-access-api/</a></p>
</blockquote>
<h1 id="使用-Jenkins-API的Java客户端"><a href="#使用-Jenkins-API的Java客户端" class="headerlink" title="使用 Jenkins API的Java客户端"></a>使用 Jenkins API的Java客户端</h1><h2 id="Maven依赖"><a href="#Maven依赖" class="headerlink" title="Maven依赖"></a>Maven依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--jenkins-java-client--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.offbytwo.jenkins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jenkins-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.3.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="连接Jenkins"><a href="#连接Jenkins" class="headerlink" title="连接Jenkins"></a>连接Jenkins</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sdu.jsy.learnjenkins.config;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: SongyangJi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>: 2022/5/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties(value = &quot;jenkins&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JenkinsConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    String url;</span><br><span class="line">    String username;</span><br><span class="line">    String token;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * JenkinsHttpClient 和 JenkinsServer 关系：</span></span><br><span class="line"><span class="comment">     * JenkinsServer 是对 JenkinsHttpClient某些功能的更高层次的封装，</span></span><br><span class="line"><span class="comment">     * JenkinsServer依赖于JenkinsHttpClient</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Http 客户端工具</span></span><br><span class="line"><span class="comment">     * 如果有些 API 该工具包未提供，可以用此Http客户端操作远程接口，执行命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JenkinsHttpClient <span class="title function_">getHttpClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JenkinsHttpClient</span> <span class="variable">jenkinsHttpClient</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jenkinsHttpClient = <span class="keyword">new</span> <span class="title class_">JenkinsHttpClient</span>(<span class="keyword">new</span> <span class="title class_">URI</span>(url), username, token);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jenkinsHttpClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接 Jenkins</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JenkinsServer <span class="title function_">connectServer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JenkinsServer</span> <span class="variable">jenkinsServer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jenkinsServer = <span class="keyword">new</span> <span class="title class_">JenkinsServer</span>(<span class="keyword">new</span> <span class="title class_">URI</span>(url), username, token);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jenkinsServer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<h2 id="操作Job"><a href="#操作Job" class="headerlink" title="操作Job"></a>操作Job</h2><p>已有一条工作流：<a target="_blank" rel="noopener" href="http://localhost:8080/job/pipeline-test/">http://localhost:8080/job/pipeline-test/</a></p>
<h3 id="创建Job"><a href="#创建Job" class="headerlink" title="创建Job"></a>创建Job</h3><h4 id="查看xml定义"><a href="#查看xml定义" class="headerlink" title="查看xml定义"></a>查看xml定义</h4><p>查看定义它的xml：<a target="_blank" rel="noopener" href="http://localhost:8080/job/pipeline-test/config.xml">http://localhost:8080/job/pipeline-test/config.xml</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.1&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">flow-definition</span> <span class="attr">plugin</span>=<span class="string">&quot;workflow-job@1180.v04c4e75dce43&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">actions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobAction</span> <span class="attr">plugin</span>=<span class="string">&quot;pipeline-model-definition@2.2077.vc78ec45162f1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction</span> <span class="attr">plugin</span>=<span class="string">&quot;pipeline-model-definition@2.2077.vc78ec45162f1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">jobProperties</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">triggers</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">parameters</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">options</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">actions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span><span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">keepDependencies</span>&gt;</span>false<span class="tag">&lt;/<span class="name">keepDependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.dabsquared.gitlabjenkins.connection.GitLabConnectionProperty</span> <span class="attr">plugin</span>=<span class="string">&quot;gitlab-plugin@1.5.31&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">gitLabConnection</span>&gt;</span><span class="tag">&lt;/<span class="name">gitLabConnection</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">jobCredentialId</span>&gt;</span><span class="tag">&lt;/<span class="name">jobCredentialId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">useAlternativeCredential</span>&gt;</span>false<span class="tag">&lt;/<span class="name">useAlternativeCredential</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">com.dabsquared.gitlabjenkins.connection.GitLabConnectionProperty</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hudson.model.ParametersDefinitionProperty</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">parameterDefinitions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">net.uaznia.lukanus.hudson.plugins.gitparameter.GitParameterDefinition</span> <span class="attr">plugin</span>=<span class="string">&quot;git-parameter@0.9.16&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">name</span>&gt;</span>branch_tag<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>912c32f3-e614-420d-80f3-f8086c4691d6<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">type</span>&gt;</span>PT_BRANCH_TAG<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">branch</span>&gt;</span><span class="tag">&lt;/<span class="name">branch</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tagFilter</span>&gt;</span>*<span class="tag">&lt;/<span class="name">tagFilter</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">branchFilter</span>&gt;</span>.*<span class="tag">&lt;/<span class="name">branchFilter</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">sortMode</span>&gt;</span>NONE<span class="tag">&lt;/<span class="name">sortMode</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">defaultValue</span>&gt;</span>origin/master<span class="tag">&lt;/<span class="name">defaultValue</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">selectedValue</span>&gt;</span>NONE<span class="tag">&lt;/<span class="name">selectedValue</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">quickFilterEnabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">quickFilterEnabled</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">listSize</span>&gt;</span>5<span class="tag">&lt;/<span class="name">listSize</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">requiredParameter</span>&gt;</span>false<span class="tag">&lt;/<span class="name">requiredParameter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">net.uaznia.lukanus.hudson.plugins.gitparameter.GitParameterDefinition</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hudson.model.StringParameterDefinition</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">name</span>&gt;</span>port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">defaultValue</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">defaultValue</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">trim</span>&gt;</span>false<span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">hudson.model.StringParameterDefinition</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">parameterDefinitions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hudson.model.ParametersDefinitionProperty</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">triggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.dabsquared.gitlabjenkins.GitLabPushTrigger</span> <span class="attr">plugin</span>=<span class="string">&quot;gitlab-plugin@1.5.31&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">spec</span>&gt;</span><span class="tag">&lt;/<span class="name">spec</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">triggerOnPush</span>&gt;</span>true<span class="tag">&lt;/<span class="name">triggerOnPush</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">triggerToBranchDeleteRequest</span>&gt;</span>false<span class="tag">&lt;/<span class="name">triggerToBranchDeleteRequest</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">triggerOnMergeRequest</span>&gt;</span>false<span class="tag">&lt;/<span class="name">triggerOnMergeRequest</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">triggerOnlyIfNewCommitsPushed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">triggerOnlyIfNewCommitsPushed</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">triggerOnPipelineEvent</span>&gt;</span>false<span class="tag">&lt;/<span class="name">triggerOnPipelineEvent</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">triggerOnAcceptedMergeRequest</span>&gt;</span>true<span class="tag">&lt;/<span class="name">triggerOnAcceptedMergeRequest</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">triggerOnClosedMergeRequest</span>&gt;</span>false<span class="tag">&lt;/<span class="name">triggerOnClosedMergeRequest</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">triggerOnApprovedMergeRequest</span>&gt;</span>true<span class="tag">&lt;/<span class="name">triggerOnApprovedMergeRequest</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">triggerOpenMergeRequestOnPush</span>&gt;</span>never<span class="tag">&lt;/<span class="name">triggerOpenMergeRequestOnPush</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">triggerOnNoteRequest</span>&gt;</span>true<span class="tag">&lt;/<span class="name">triggerOnNoteRequest</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">noteRegex</span>&gt;</span>Jenkins please retry a build<span class="tag">&lt;/<span class="name">noteRegex</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ciSkip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">ciSkip</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">skipWorkInProgressMergeRequest</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipWorkInProgressMergeRequest</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">labelsThatForcesBuildIfAdded</span>&gt;</span><span class="tag">&lt;/<span class="name">labelsThatForcesBuildIfAdded</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">setBuildDescription</span>&gt;</span>true<span class="tag">&lt;/<span class="name">setBuildDescription</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">branchFilterType</span>&gt;</span>All<span class="tag">&lt;/<span class="name">branchFilterType</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">includeBranchesSpec</span>&gt;</span><span class="tag">&lt;/<span class="name">includeBranchesSpec</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">excludeBranchesSpec</span>&gt;</span><span class="tag">&lt;/<span class="name">excludeBranchesSpec</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">sourceBranchRegex</span>&gt;</span><span class="tag">&lt;/<span class="name">sourceBranchRegex</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">targetBranchRegex</span>&gt;</span><span class="tag">&lt;/<span class="name">targetBranchRegex</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">secretToken</span>&gt;</span>&#123;AQAAABAAAAAQGEXb6DKS0zJvyDXcbayiGrgglRQ7E35la+RU6p8KpAc=&#125;<span class="tag">&lt;/<span class="name">secretToken</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">pendingBuildName</span>&gt;</span><span class="tag">&lt;/<span class="name">pendingBuildName</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">cancelPendingBuildsOnUpdate</span>&gt;</span>false<span class="tag">&lt;/<span class="name">cancelPendingBuildsOnUpdate</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">com.dabsquared.gitlabjenkins.GitLabPushTrigger</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">triggers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">definition</span> <span class="attr">class</span>=<span class="string">&quot;org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition&quot;</span> <span class="attr">plugin</span>=<span class="string">&quot;workflow-cps@2689.v434009a_31b_f1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml">pipeline &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    agent any</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    </span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    stages &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        stage(<span class="symbol">&amp;apos;</span>Stage 1: Fetch code from git<span class="symbol">&amp;apos;</span>) &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            steps &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                echo <span class="symbol">&amp;apos;</span>Stage 1: Fetch code from git -- SUCCESS<span class="symbol">&amp;apos;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        stage(<span class="symbol">&amp;apos;</span>Stage 2: Build the project using maven<span class="symbol">&amp;apos;</span>) &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            steps &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                echo <span class="symbol">&amp;apos;</span>Stage 2: Build the project using maven -- SUCCESS<span class="symbol">&amp;apos;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        stage(<span class="symbol">&amp;apos;</span>Stage 3: Make a custom image using docker<span class="symbol">&amp;apos;</span>) &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            steps &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                echo <span class="symbol">&amp;apos;</span>Stage 3: Make a custom image using docker -- SUCCESS<span class="symbol">&amp;apos;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        stage(<span class="symbol">&amp;apos;</span>Stage 4: Push image to Harbor<span class="symbol">&amp;apos;</span>) &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            steps &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                echo <span class="symbol">&amp;apos;</span>Stage 4: Push image to Harbor -- SUCCESS<span class="symbol">&amp;apos;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        stage(<span class="symbol">&amp;apos;</span>Stage 5: Publish over SSH<span class="symbol">&amp;apos;</span>) &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            steps &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                echo <span class="symbol">&amp;apos;</span>Stage 5: Publish over SSH -- SUCCESS<span class="symbol">&amp;apos;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">&#125;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sandbox</span>&gt;</span>true<span class="tag">&lt;/<span class="name">sandbox</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">definition</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">triggers</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">disabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">disabled</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">flow-definition</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其实此xml存放于<code>$JENKINS_HOME/jobs/pipeline-test/config.xml</code>，也就是<code>$JENKINS_HOME/jobs/$JOB/config.xml</code>这个文件。</p>
<h4 id="运行代码"><a href="#运行代码" class="headerlink" title="运行代码"></a>运行代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jenkinsServer.createJob(<span class="string">&quot;pipeline2&quot;</span>, xml); <span class="comment">// xml如上</span></span><br></pre></td></tr></table></figure>
<p>抛出异常<code>org.apache.http.client.HttpResponseException: status code: 403, reason phrase: Forbidden</code> 。</p>
<blockquote>
<p>解决方案：<a target="_blank" rel="noopener" href="https://blog.csdn.net/ccc_bigdata/article/details/108080084">https://blog.csdn.net/ccc_bigdata/article/details/108080084</a></p>
</blockquote>
<h1 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h1><p>下载客户端jar：<a target="_blank" rel="noopener" href="http://211.87.224.233:18080/cli/">http://211.87.224.233:18080/cli/</a></p>
<ul>
<li><p>用法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar jenkins-cli.jar [-s URL] command [opts...] args...</span><br></pre></td></tr></table></figure>
</li>
<li><p>示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar jenkins-cli.jar -s http://211.87.224.233:18080/ -auth admin:admin -webSocket help</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p> 参考文档</p>
<p><a target="_blank" rel="noopener" href="http://www.mydlq.club/article/23/">http://www.mydlq.club/article/23/</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/09/IP%E5%9C%B0%E5%9D%800.0.0.0%E6%98%AF%E4%BB%80%E4%B9%88%E6%84%8F%E6%80%9D%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SongyangJi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JsyBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | JsyBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/09/IP%E5%9C%B0%E5%9D%800.0.0.0%E6%98%AF%E4%BB%80%E4%B9%88%E6%84%8F%E6%80%9D%EF%BC%9F/" class="post-title-link" itemprop="url">IP地址0.0.0.0是什么意思？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-09 00:27:15 / 修改时间：00:28:52" itemprop="dateCreated datePublished" datetime="2022-05-09T00:27:15+08:00">2022-05-09</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="IP地址-0-0-0-0-是什么意思"><a href="#IP地址-0-0-0-0-是什么意思" class="headerlink" title="IP地址 0.0.0.0 是什么意思"></a>IP地址 0.0.0.0 是什么意思</h1><h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><p>IPV4中，0.0.0.0地址被用于表示一个无效的，未知的或者不可用的目标。</p>
<p>在服务器中，0.0.0.0指的是本机上的所有IPV4地址，如果一个主机有两个IP地址，192.168.1.1 和 10.1.2.1，并且该主机上的一个服务监听的地址是0.0.0.0 和端口 8080,那么通过这两个&lt;ip地址:8080&gt;都能够访问该服务。<br>在路由中，0.0.0.0表示的是默认路由，即当路由表中没有找到完全匹配的路由的时候所对应的路由。</p>
<h2 id="用途总结"><a href="#用途总结" class="headerlink" title="用途总结"></a>用途总结</h2><p>当一台主机还没有被分配一个IP地址的时候，用于表示主机本身。（DHCP分配IP地址的时候）<br>用作默认路由，表示”任意IPV4主机”。<br>用来表示目标机器不可用。<br>用作服务端，表示本机上的任意IPV4地址。<br>网关地址 0.0.0.0 表示直连规则，即当前记录对应的 Destination 跟本机在同一个网段，通信时不需要经过网关(路由器)。也就是说使用二层交换机通过MAC即可通信。</p>
<p>命中容器的路由表直连规则，意思是目的IP是在局域网内，不用走到出口网关<br>局域网内直接是通过二层网络来发送包。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/08/%E4%BD%BF%E7%94%A8Docker%E7%9A%84API%E5%8F%8ASDK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SongyangJi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JsyBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | JsyBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/08/%E4%BD%BF%E7%94%A8Docker%E7%9A%84API%E5%8F%8ASDK/" class="post-title-link" itemprop="url">使用Docker的API及SDK</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-08 02:20:39" itemprop="dateCreated datePublished" datetime="2022-05-08T02:20:39+08:00">2022-05-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-03 12:46:35" itemprop="dateModified" datetime="2022-06-03T12:46:35+08:00">2022-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Docker的HTTP-API"><a href="#Docker的HTTP-API" class="headerlink" title="Docker的HTTP-API"></a>Docker的HTTP-API</h1><h2 id="开启远程访问端口2375"><a href="#开启远程访问端口2375" class="headerlink" title="开启远程访问端口2375"></a>开启远程访问端口2375</h2><h3 id="修改-x2F-etc-x2F-default-x2F-docker（失败）"><a href="#修改-x2F-etc-x2F-default-x2F-docker（失败）" class="headerlink" title="修改&#x2F;etc&#x2F;default&#x2F;docker（失败）"></a><del>修改&#x2F;etc&#x2F;default&#x2F;docker（失败）</del></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/default/docker</span><br></pre></td></tr></table></figure>

<p>加上</p>
<p>DOCKER_OPTS&#x3D;”-H tcp:&#x2F;&#x2F;0.0.0.0:2375”</p>
<p>再</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>





<h3 id="修改-x2F-etc-x2F-docker-x2F-daemon-json（失败）"><a href="#修改-x2F-etc-x2F-docker-x2F-daemon-json（失败）" class="headerlink" title="修改&#x2F;etc&#x2F;docker&#x2F;daemon.json（失败）"></a><del>修改&#x2F;etc&#x2F;docker&#x2F;daemon.json（失败）</del></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<p>加入</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;tcp://0.0.0.0:2375&quot;</span><span class="punctuation">,</span> <span class="string">&quot;unix:///var/run/docker.sock&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>“unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock”：unix socket，本地客户端将通过这个来连接 Docker Daemon。</li>
<li>“tcp:&#x2F;&#x2F;0.0.0.0:2375”：tcp socket，表示允许任何远程客户端通过 2375 端口连接 Docker Daemon。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>查看docker进程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep docker</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">root      44221      1  1 18:16 ?        00:00:06 /usr/bin/dockerd -H tcp://0.0.0.0:2375 -H <span class="comment">#unix://var/run/docker.sock</span></span></span><br></pre></td></tr></table></figure>
<p>Docker守护进程打开一个HTTP Socket,这样才能实现远程通信</p>
<h3 id="修改-x2F-usr-x2F-lib-x2F-systemd-x2F-system-x2F-docker-service（成功）"><a href="#修改-x2F-usr-x2F-lib-x2F-systemd-x2F-system-x2F-docker-service（成功）" class="headerlink" title="修改&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;docker.service（成功）"></a>修改&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;docker.service（成功）</h3><p>在&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;docker.service，配置远程访问。</p>
<p>主要是在[Service]这个部分，加上两个参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vim /usr/lib/systemd/system/docker.service</span></span><br><span class="line">[Service]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock</span><br></pre></td></tr></table></figure>

<p>重启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>



<p>这次检查我们看到了这个tcp进程:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root      117236       1  1 02:52 ?        00:00:05 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://0.0.0.0:2375 -H unix://var/run/docker.soc</span><br></pre></td></tr></table></figure>



<h2 id="使用Remote-cocker-daemon"><a href="#使用Remote-cocker-daemon" class="headerlink" title="使用Remote cocker daemon"></a>使用Remote cocker daemon</h2><h3 id="shell远程连接"><a href="#shell远程连接" class="headerlink" title="shell远程连接"></a>shell远程连接</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加上请求主机即可</span></span><br><span class="line">docker -H tcp://211.87.224.233:2375 version</span><br><span class="line">docker -H tcp://ip:port ps</span><br><span class="line">docker -H tcp://ip:port images</span><br></pre></td></tr></table></figure>



<h3 id="RestAPI"><a href="#RestAPI" class="headerlink" title="RestAPI"></a>RestAPI</h3><p>浏览器访问：</p>
<p>比如想要查看版本 <a href="http://ip:port/version">http://ip:port/version</a></p>
<p>其他的操作入口，请参考</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/api/v1.41/#tag/Container">Docker API Reference</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hongdada/p/11512901.html">Docker开启Remote API 访问 2375端口 </a></p>
</blockquote>
<h1 id="Docker-SDK-Go"><a href="#Docker-SDK-Go" class="headerlink" title="Docker-SDK-Go"></a>Docker-SDK-Go</h1><h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><h3 id="构造客户端"><a href="#构造客户端" class="headerlink" title="构造客户端"></a>构造客户端</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/client&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	<span class="comment">// cli, err := client.NewClientWithOpts(client.FromEnv)</span></span><br><span class="line">	<span class="comment">// remoteDockerDaemonAddress := &quot;211.87.224.233:2375&quot;</span></span><br><span class="line">	<span class="comment">// cli, err := client.NewClientWithOpts(client.FromEnv, client.WithHost(&quot;tcp://&quot; + remoteDockerDaemonAddress))</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>既可以连接本地，也可以连接远程的docker。</p>
<h3 id="登录Registry私服并拉取镜像"><a href="#登录Registry私服并拉取镜像" class="headerlink" title="登录Registry私服并拉取镜像"></a>登录Registry私服并拉取镜像</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/api/types&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/client&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	cli, err := client.NewClientWithOpts(client.FromEnv)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	harborUrl := <span class="string">&quot;http://211.87.224.233:8930/&quot;</span></span><br><span class="line">	_, err = cli.RegistryLogin(ctx, types.AuthConfig&#123;</span><br><span class="line">		Username:      <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">		Password:      <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">		ServerAddress: harborUrl,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	imageName := <span class="string">&quot;211.87.224.233:8930/sdu-weblab/hello-world&quot;</span></span><br><span class="line">  <span class="comment">// out 是响应输出流，可以不输出</span></span><br><span class="line">	out, err := cli.ImagePull(ctx, imageName, types.ImagePullOptions&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> out.Close()</span><br><span class="line">	io.Copy(os.Stdout, out)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="查看容器的详细信息，如端口映射"><a href="#查看容器的详细信息，如端口映射" class="headerlink" title="查看容器的详细信息，如端口映射"></a><del>查看容器的详细信息，如端口映射</del></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/client&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/go-connections/nat&quot;</span></span><br><span class="line">	<span class="string">&quot;os/exec&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//ip, port, err := getHostIpAndPortOfContainerPort(&quot;8af85dfb4659&quot;, &quot;80&quot;)</span></span><br><span class="line">	ip, port, err := getHostIpAndPortOfContainerPortFromConfig(<span class="string">&quot;8bfb9b8e2692&quot;</span>, <span class="string">&quot;80&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;ip:port = %s:%s&quot;</span>, ip, port)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getHostIpAndPortOfContainerPortFromConfig</span><span class="params">(containerId <span class="type">string</span>, containerPort <span class="type">string</span>)</span></span> (ip <span class="type">string</span>, port <span class="type">string</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	cli, err := client.NewClientWithOpts(client.FromEnv)</span><br><span class="line">	containerJSON, err := cli.ContainerInspect(context.Background(), containerId)</span><br><span class="line">	<span class="keyword">if</span> !containerJSON.HostConfig.PublishAllPorts &#123; <span class="comment">// -p hostPort:containerPort</span></span><br><span class="line">		_port, err := nat.NewPort(nat.SplitProtoPort(containerPort))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		portBindMap := containerJSON.HostConfig.PortBindings</span><br><span class="line">		bindings := portBindMap[_port]</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(bindings) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, errors.New(fmt.Sprintf(<span class="string">&quot;%s has no bindings&quot;</span>, containerPort))</span><br><span class="line">		&#125;</span><br><span class="line">		ip = bindings[<span class="number">0</span>].HostIP</span><br><span class="line">		port = bindings[<span class="number">0</span>].HostPort</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(ip) == <span class="number">0</span> &#123;</span><br><span class="line">			ip = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ip, port, <span class="literal">nil</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">// -P containerPort</span></span><br><span class="line">		<span class="keyword">return</span> getHostIpAndPortOfContainerPort(containerId, containerPort)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// todo </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getHostIpAndPortOfContainerPort</span><span class="params">(containerId <span class="type">string</span>, containerPort <span class="type">string</span>)</span></span> (ip <span class="type">string</span>, port <span class="type">string</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	shell := <span class="string">&quot;docker port &quot;</span> + containerId + <span class="string">&quot; | grep &quot;</span> + containerPort + <span class="string">&quot; | awk &#x27;&#123;print $3&#125;&#x27;&quot;</span></span><br><span class="line">	fmt.Println(shell)</span><br><span class="line">	output, err := exec.Command(<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, shell).Output()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	ipPort := <span class="type">string</span>(output)</span><br><span class="line">	<span class="comment">//fmt.Println(ipPort)</span></span><br><span class="line">	splits := strings.Split(ipPort, <span class="string">&quot;:&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(splits) != <span class="number">2</span> &#123;</span><br><span class="line">		err = errors.New(<span class="string">&quot;invalid format&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	ip = splits[<span class="number">0</span>]</span><br><span class="line">	port = splits[<span class="number">1</span>]</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果端口是用<code>-P</code>的方式随机映射的话就不能用<code>ContainerInspect</code>这个API了。</p>
<h3 id="获取端口映射（获取其一即可）"><a href="#获取端口映射（获取其一即可）" class="headerlink" title="获取端口映射（获取其一即可）"></a>获取端口映射（获取其一即可）</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getHostPortOfContainerPort</span><span class="params">(containerId <span class="type">string</span>, containerPort <span class="type">string</span>)</span></span> (port <span class="type">string</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	shell := <span class="string">&quot;docker port &quot;</span> + containerId + <span class="string">&quot; | grep &quot;</span> + containerPort + <span class="string">&quot; | awk &#x27;&#123;print $3&#125;&#x27;&quot;</span></span><br><span class="line">	output, err := exec.Command(<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, shell).Output()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	shellOut := <span class="type">string</span>(output)</span><br><span class="line">	shellOut = <span class="string">&quot;0.0.0.0:49155\n:::49155&quot;</span></span><br><span class="line">	parts := strings.Split(shellOut, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(parts) == <span class="number">0</span> &#123;</span><br><span class="line">		err = fmt.Errorf(<span class="string">&quot;containerPort=%s has no bindings&quot;</span>, containerPort)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	ipPort := parts[<span class="number">0</span>]</span><br><span class="line">	splits := strings.Split(ipPort, <span class="string">&quot;:&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(splits) != <span class="number">2</span> &#123;</span><br><span class="line">		err = errors.New(<span class="string">&quot;invalid format&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	port = splits[<span class="number">1</span>]</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<h3 id="创建容器"><a href="#创建容器" class="headerlink" title="创建容器"></a>创建容器</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    imageName     <span class="type">string</span>   = <span class="string">&quot;my-gin:latest&quot;</span>                      <span class="comment">//镜像名称</span></span><br><span class="line">    containerName <span class="type">string</span>   = <span class="string">&quot;mygin-latest&quot;</span>                       <span class="comment">//容器名称</span></span><br><span class="line">    indexName     <span class="type">string</span>   = <span class="string">&quot;/&quot;</span> + containerName                  <span class="comment">//容器索引名称，用于检查该容器是否存在是使用</span></span><br><span class="line">    cmd           <span class="type">string</span>   = <span class="string">&quot;./ginDocker2&quot;</span>                       <span class="comment">//运行的cmd命令，用于启动container中的程序</span></span><br><span class="line">    workDir       <span class="type">string</span>   = <span class="string">&quot;/go/src/ginDocker2&quot;</span>                 <span class="comment">//container工作目录</span></span><br><span class="line">    openPort      nat.Port = <span class="string">&quot;7070&quot;</span>                               <span class="comment">//container开放端口</span></span><br><span class="line">    hostPort      <span class="type">string</span>   = <span class="string">&quot;7070&quot;</span>                               <span class="comment">//container映射到宿主机的端口</span></span><br><span class="line">    containerDir  <span class="type">string</span>   = <span class="string">&quot;/go/src/ginDocker2&quot;</span>                 <span class="comment">//容器挂载目录</span></span><br><span class="line">    hostDir       <span class="type">string</span>   = <span class="string">&quot;/home/youngblood/Go/src/ginDocker2&quot;</span> <span class="comment">//容器挂在载宿主机的目录</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建容器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createContainer</span><span class="params">(ctx context.Context, cli *client.Client)</span></span> &#123;</span><br><span class="line">    <span class="comment">//创建容器</span></span><br><span class="line">    cont, err := cli.ContainerCreate(ctx, &amp;container.Config&#123;</span><br><span class="line">        Image:      imageName,     <span class="comment">//镜像名称</span></span><br><span class="line">        Tty:        <span class="literal">true</span>,          <span class="comment">//docker run命令中的-t选项</span></span><br><span class="line">        OpenStdin:  <span class="literal">true</span>,          <span class="comment">//docker run命令中的-i选项</span></span><br><span class="line">        Cmd:        []<span class="type">string</span>&#123;cmd&#125;, <span class="comment">//docker 容器中执行的命令</span></span><br><span class="line">        WorkingDir: workDir,       <span class="comment">//docker容器中的工作目录</span></span><br><span class="line">        ExposedPorts: nat.PortSet&#123;</span><br><span class="line">            openPort: <span class="keyword">struct</span>&#123;&#125;&#123;&#125;, <span class="comment">//docker容器对外开放的端口</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;, &amp;container.HostConfig&#123;</span><br><span class="line">        PortBindings: nat.PortMap&#123;</span><br><span class="line">            <span class="comment">// 一个容器端口可以”一对多“地映射到多个宿主机端口</span></span><br><span class="line">            openPort: []nat.PortBinding&#123;nat.PortBinding&#123;</span><br><span class="line">                HostIP:   <span class="string">&quot;0.0.0.0&quot;</span>, <span class="comment">//docker容器映射的宿主机的ip, 0.0.0.0 表示服务器的所有可监听的ip</span></span><br><span class="line">                HostPort: hostPort,  <span class="comment">//docker 容器映射到宿主机的端口;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        Mounts: []mount.Mount&#123; <span class="comment">//docker 容器目录挂在到宿主机目录</span></span><br><span class="line">            mount.Mount&#123;</span><br><span class="line">                Type:   mount.TypeBind,</span><br><span class="line">                Source: hostDir,</span><br><span class="line">                Target: containerDir,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;, <span class="literal">nil</span>, containerName)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;success create container:%s\n&quot;</span>, cont.ID)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.Println(<span class="string">&quot;failed to create container!!!!!!!!!!!!!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要实现-P（随机映射端口的话）的话：使用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;container.HostConfig&#123;</span><br><span class="line">   PublishAllPorts: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>举例</strong></p>
<p>将<code>docker run -d -p 9000:80 --name docker.getting-started.latest docker/getting-started:latest</code>改写为docker程序：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/api/types&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/api/types/container&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/client&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/go-connections/nat&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	cli, err := client.NewClientWithOpts(client.FromEnv)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	imageName := <span class="string">&quot;docker/getting-started:latest&quot;</span></span><br><span class="line">	containerName := <span class="string">&quot;docker.getting-started.latest&quot;</span></span><br><span class="line">	containerPort := nat.Port(<span class="string">&quot;80&quot;</span>)</span><br><span class="line">	hostPort := <span class="string">&quot;9000&quot;</span></span><br><span class="line">	resp, err := cli.ContainerCreate(ctx,</span><br><span class="line">		&amp;container.Config&#123;</span><br><span class="line">			Image: imageName,</span><br><span class="line">			ExposedPorts: nat.PortSet&#123;</span><br><span class="line">				containerPort: <span class="keyword">struct</span>&#123;&#125;&#123;&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;, &amp;container.HostConfig&#123;</span><br><span class="line">			PortBindings: nat.PortMap&#123;</span><br><span class="line">				containerPort: []nat.PortBinding&#123; <span class="comment">//</span></span><br><span class="line">					&#123;</span><br><span class="line">						HostIP:   <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">						HostPort: hostPort,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;, <span class="literal">nil</span>, <span class="literal">nil</span>, containerName)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := cli.ContainerStart(ctx, resp.ID, types.ContainerStartOptions&#123;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;containerID = %s\n&quot;</span>, resp.ID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="读取日志"><a href="#读取日志" class="headerlink" title="读取日志"></a>读取日志</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;io&quot;</span></span><br><span class="line">   <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="string">&quot;github.com/docker/docker/api/types&quot;</span></span><br><span class="line">   <span class="string">&quot;github.com/docker/docker/client&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   ctx := context.Background()</span><br><span class="line">   cli, err := client.NewClientWithOpts(client.FromEnv)</span><br><span class="line">   <span class="comment">//remoteDockerDaemonAddress := &quot;211.87.224.233:2375&quot;</span></span><br><span class="line">   <span class="comment">//cli, err := client.NewClientWithOpts(client.FromEnv, client.WithHost(&quot;tcp://&quot;+remoteDockerDaemonAddress))</span></span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="built_in">panic</span>(err)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   options := types.ContainerLogsOptions&#123;</span><br><span class="line">      ShowStdout: <span class="literal">true</span>,</span><br><span class="line">      ShowStderr: <span class="literal">true</span>,</span><br><span class="line">      Follow:     <span class="literal">true</span>,</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// Replace this ID with a container that really exists</span></span><br><span class="line">   out, err := cli.ContainerLogs(ctx, <span class="string">&quot;87f42c0ab7f5&quot;</span>, options)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="built_in">panic</span>(err)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   io.Copy(os.Stdout, out)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>如果将日志实时输出到websocket呢？如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bufio&quot;</span></span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/api/types&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/client&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gorilla/websocket&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DefaultBufferSize = <span class="number">4</span> * <span class="number">1024</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	out      io.ReadCloser</span><br><span class="line">	upgrader = websocket.Upgrader&#123;</span><br><span class="line">		CheckOrigin: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;,</span><br><span class="line">	&#125; <span class="comment">// use default options</span></span><br><span class="line">	conn *websocket.Conn</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	<span class="comment">//cli, err := client.NewClientWithOpts(client.FromEnv)</span></span><br><span class="line">	remoteDockerDaemonAddress := <span class="string">&quot;211.87.224.233:2375&quot;</span></span><br><span class="line">	cli, err := client.NewClientWithOpts(client.FromEnv, client.WithHost(<span class="string">&quot;tcp://&quot;</span>+remoteDockerDaemonAddress))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	options := types.ContainerLogsOptions&#123;</span><br><span class="line">		ShowStdout: <span class="literal">true</span>,</span><br><span class="line">		ShowStderr: <span class="literal">true</span>,</span><br><span class="line">		Follow:     <span class="literal">true</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Replace this ID with a container that really exists</span></span><br><span class="line">	<span class="comment">//out, err = cli.ContainerLogs(ctx, &quot;8bfb9b8e2692&quot;, options) // local</span></span><br><span class="line">	out, err = cli.ContainerLogs(ctx, <span class="string">&quot;87f42c0ab7f5&quot;</span>, options) <span class="comment">// remote</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/logs&quot;</span>, socketHandler)</span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">&quot;localhost:8081&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">socketHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Upgrade our raw HTTP connection to a websocket based one</span></span><br><span class="line">	_conn, err := upgrader.Upgrade(w, r, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Print(<span class="string">&quot;Error during connection upgradation:&quot;</span>, err)</span><br><span class="line">		os.Exit(<span class="number">3</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	conn = _conn</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">	reader := bufio.NewReader(out)</span><br><span class="line">	<span class="comment">// The event loop</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		message, err := reader.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">				exitAndNotifyPeer(message, <span class="number">0</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			exitAndNotifyPeer(<span class="string">&quot;\n&quot;</span>, <span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// todo delete</span></span><br><span class="line">		log.Printf(<span class="string">&quot;Log read is: %s&quot;</span>, message)</span><br><span class="line"></span><br><span class="line">		err = conn.WriteMessage(websocket.TextMessage, []<span class="type">byte</span>(message))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;Error during message writing: &quot;</span>, err)</span><br><span class="line">			os.Exit(<span class="number">2</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">exitAndNotifyPeer</span><span class="params">(msg <span class="type">string</span>, exitCode <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	conn.WriteMessage(websocket.CloseMessage, []<span class="type">byte</span>(msg))</span><br><span class="line">	os.Exit(exitCode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<blockquote>
<p>参考文档</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/api/sdk/examples/">一些小例子</a></p>
<p><a target="_blank" rel="noopener" href="https://pkg.go.dev/github.com/docker/docker/client">Reference</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/08/Git%E7%9A%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SongyangJi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JsyBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | JsyBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/08/Git%E7%9A%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Git的学习笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-08 01:43:28" itemprop="dateCreated datePublished" datetime="2022-05-08T01:43:28+08:00">2022-05-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-10-18 15:52:14" itemprop="dateModified" datetime="2022-10-18T15:52:14+08:00">2022-10-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h1><p>Mac上使用图形化安装工具、brew、xcode自带的都可以。<br>检查</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git --version</span><br></pre></td></tr></table></figure>

<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>配置文件为 *gitconfig</p>
<p>作用域有三种：</p>
<ol>
<li>系统 system (&#x2F;etc&#x2F;gitconfig)</li>
<li>全局（用户）global (在 ~&#x2F;.gitconfig )</li>
<li>项目 (在仓库的 &#x2F;project&#x2F;.git&#x2F;config)</li>
</ol>
<ul>
<li><p>查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --list</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name <span class="string">&#x27;jsy&#x27;</span></span><br><span class="line">git config --global user.email <span class="string">&#x27;153xxxxx@qq.com&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><h2 id="版本库、工作区、暂存区"><a href="#版本库、工作区、暂存区" class="headerlink" title="版本库、工作区、暂存区"></a>版本库、工作区、暂存区</h2><ul>
<li><p>版本库<br>就是那个 .git<br>里面有</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jisongyang@SongyangJi-MacBookAir .git % <span class="built_in">ls</span></span><br><span class="line">HEAD		description	info		refs</span><br><span class="line">config		hooks		objects</span><br></pre></td></tr></table></figure>

</li>
<li><p>工作区<br>我们能看到的那个包含.git的文件夹, 比如下面的那个 repo 文件夹就是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jisongyang@SongyangJi-MacBookAir .git % <span class="built_in">cd</span> ..</span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo % <span class="built_in">pwd</span></span><br><span class="line">/Users/jisongyang/learn-git-repo/repo</span><br></pre></td></tr></table></figure>
</li>
<li><p>暂存区<br>临时保存的修改的文件的地方</p>
</li>
</ul>
<h2 id="git下文件的状态"><a href="#git下文件的状态" class="headerlink" title="git下文件的状态"></a>git下文件的状态</h2><ol>
<li>untracked 未被git管理</li>
<li>tracked<ol>
<li>unmodified 未修改</li>
<li>modified 已修改</li>
<li>staged 暂存</li>
</ol>
</li>
</ol>
<p>查看状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br><span class="line"><span class="comment"># 未跟踪</span></span><br><span class="line">git status -s</span><br></pre></td></tr></table></figure>

<p>举例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">jisongyang@SongyangJi-MacBookAir repo % clear</span><br><span class="line"><span class="comment"># 未跟踪</span></span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo % git status -s</span><br><span class="line">?? a.txt</span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo % git add a.txt</span><br><span class="line"><span class="comment"># 已跟踪</span></span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo % git status -s</span><br><span class="line">A  a.txt</span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo % <span class="built_in">echo</span> hello &gt;&gt; a.txt</span><br><span class="line"><span class="comment"># 已修改</span></span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo % git status -s</span><br><span class="line">AM a.txt</span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo % git reset a.txt</span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo % git status -s</span><br><span class="line">?? a.txt</span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo % git commit a.txt</span><br><span class="line">[master (root-commit) 5273424] init a.txt</span><br><span class="line"> 1 file changed, 2 insertions(+)</span><br><span class="line"> create mode 100644 a.txt</span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo % git status -s</span><br><span class="line"><span class="comment"># a.txt 在状态里不可见了</span></span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo %</span><br></pre></td></tr></table></figure>

<h2 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h2><p>当有文件不需要git管理的时候，使用这个文件就很有必要了。<br>比如日志、项目编译出来的文件、IDEA的本地信息等等，就不需要git管理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文件名固定</span></span><br><span class="line"><span class="built_in">touch</span> .gitignore</span><br></pre></td></tr></table></figure>

<p>看例子就好</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 忽略所有 *.class</span></span><br><span class="line">*.class</span><br><span class="line"><span class="comment"># 但是不忽略Hello.class</span></span><br><span class="line">!Hello.class</span><br><span class="line"><span class="comment"># 忽略当前目录下的TODO文件夹</span></span><br><span class="line">/TODO </span><br><span class="line"><span class="comment"># 忽略 target 下的所有文件</span></span><br><span class="line">target/</span><br><span class="line"><span class="comment"># 忽略 doc/*.txt的所有文件夹</span></span><br><span class="line">doc/*.txt</span><br><span class="line"><span class="comment">## 忽略 doc及其所有子目录下所有的 *.txt</span></span><br><span class="line">doc/**/*.txt</span><br></pre></td></tr></table></figure>


<h2 id="仓库"><a href="#仓库" class="headerlink" title="仓库"></a>仓库</h2><ul>
<li>在本地初始化仓库</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure>
<p>创建完会多一个 .init文件(默认不可见)</p>
<ul>
<li>从远程仓库克隆<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> repo</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="暂存区"><a href="#暂存区" class="headerlink" title="暂存区"></a>暂存区</h2><p>从工作区到暂存区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add filename</span><br><span class="line"><span class="comment"># 添加全部文件</span></span><br><span class="line">git add .</span><br></pre></td></tr></table></figure>
<p>暂存区的目录树会被重写，被 master 分支指向的目录树所替换，但是工作区不受影响</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset HEAD</span><br></pre></td></tr></table></figure>

<p>直接从暂存区删除文件，工作区则不做出改变</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">rm</span> --cached -f &lt;file&gt;</span><br></pre></td></tr></table></figure>


<h2 id="版本库"><a href="#版本库" class="headerlink" title="版本库"></a>版本库</h2><ul>
<li><p>从暂存区到版本库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -m <span class="string">&#x27;message&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改上一次的commit</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit --amend</span><br></pre></td></tr></table></figure>
<p>具体使用方法见<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/100243017">git commit –amend 修改git提交记录用法详解</a></p>
</li>
</ul>
<h1 id="远程仓库"><a href="#远程仓库" class="headerlink" title="远程仓库"></a>远程仓库</h1><p><strong>查看已连接的远程仓库</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git remote</span><br><span class="line">git remote -v</span><br><span class="line">git remote show origin</span><br></pre></td></tr></table></figure>

<p><strong>添加远程仓库</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add [shortname] url</span><br></pre></td></tr></table></figure>

<p><strong>从远程仓库克隆到本地</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> repo</span><br></pre></td></tr></table></figure>

<p><strong>移除无效的远程仓库</strong>（只是移除关联关系，不会对远程仓库有影响）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote <span class="built_in">rm</span> origin</span><br></pre></td></tr></table></figure>

<p><strong>抓取(fetch)</strong><br>从远程仓库将最新版本获取到本地仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch</span><br></pre></td></tr></table></figure>

<p><strong>拉取(pull)</strong><br>相当于fetch + merge : 从远程仓库将最新版本获取到本地仓库，并merge<br>（根据配置也可能是相当于 fetch + rebase）<br>(可能报 merge unrelated histories)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull [romote-name] [branch-name]</span><br></pre></td></tr></table></figure>

<p><strong>推送(push)</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push [romote-name] [branch-name]</span><br></pre></td></tr></table></figure>



<h1 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h1><p>master分支是git自动创建的，但没并没有什么特殊之处。</p>
<p><strong>查看分支</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出所有本地分支</span></span><br><span class="line">git branch</span><br><span class="line"><span class="comment"># 列出所有远程分支</span></span><br><span class="line">git branch -r</span><br><span class="line"><span class="comment"># 列出远程和本地分支</span></span><br><span class="line">git branch -a</span><br></pre></td></tr></table></figure>

<p><strong>创建分支</strong>(在原先分支下创建分支，内容会初始共享)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch branch-name</span><br></pre></td></tr></table></figure>
<p>举例（*master表示当前在master分支下）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jisongyang@SongyangJi-MacBookAir repo1 % git branch b1</span><br><span class="line">jisongyang@SongyangJi-MacBookAir repo1 % git branch</span><br><span class="line">  b1</span><br><span class="line">* master</span><br></pre></td></tr></table></figure>


<p><strong>切换分支</strong>（这个时候就自动把目标分支在本地仓库里的文件换到工作区里）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git checkout b1</span><br><span class="line"></span><br><span class="line"># &quot;打开&quot;远程仓库的分支</span><br><span class="line"># 如果没有全部拉下来的话</span><br><span class="line"># git fetch -all</span><br><span class="line">git checkout -b dev（本地分支名） origin/dev（远程分支名）</span><br></pre></td></tr></table></figure>

<p>两个命令合并到一步：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b dev</span><br></pre></td></tr></table></figure>


<p><strong>将本地分支推送至远程仓库</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push -u origin b1</span><br></pre></td></tr></table></figure>

<p><strong>分支合并</strong><br>(可能会冲突)<br>这里的冲突需要正确理解（这里的冲突的就像是乐观锁的加版本号一样，事实上在svn里确实有全局版本号，不允许脏写发生）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把b1分支合并到当前的master分支</span></span><br><span class="line">git merge b1</span><br></pre></td></tr></table></figure>

<p><strong>rebase</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git fetch</span><br><span class="line">git rebase dev</span><br></pre></td></tr></table></figure>

<p><strong>是rebase还是merge？</strong><br>git rebase和git merge这两个命令都旨在将更改代码从一个分支合并到另一个分支，但二者的合并方式却有很大的不同。<br>git merge优点是分支代码合并后不破坏原分支的代码提交记录，缺点就是会产生额外的提交记录并进行两条分支的合并，<br>git rebase 优点是无须新增提交记录到目标分支，rebase后可以将对象分支的提交历史续上目标分支上，形成线性提交历史记录，进行review的时候更加直观。</p>
<blockquote>
<p><strong>git rebase的黄金原则</strong><br><strong>不能对一个共享的分支进行Git rebase操作</strong>。<br><del>比如，现在在feature分支上，现在想要合并master分支的代码：<br>也就是说，如果master分支是共享的（这是一种很常见的方式），<br>那么就不能进行 git rebase master，<br>而是要进行 git merge master。</del> </p>
</blockquote>
<p>总结</p>
<ul>
<li><strong>融合代码到公共分支的时使用git merge</strong>，而不用git rebase</li>
<li><strong>融合代码到个人分支的时候使用git rebase</strong>，可以不污染分支的提交记录，形成简洁的线性提交历史记录。<br>参考 <a target="_blank" rel="noopener" href="https://joyohub.com/2020/04/06/git-rebase/">git rebase和git merge有什么区别？</a></li>
</ul>
<p><strong>删除分支</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除的是本地的分支，对远程的分支无关</span></span><br><span class="line">git branch -d branch-name</span><br><span class="line"><span class="comment"># 强制删除（git的保护，以防误删）</span></span><br><span class="line">git branch -D branch-name</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jisongyang@SongyangJi-MacBookAir repo1 % git branch -d b1</span><br><span class="line">error: The branch <span class="string">&#x27;b1&#x27;</span> is not fully merged.</span><br><span class="line">If you are sure you want to delete it, run <span class="string">&#x27;git branch -D b1&#x27;</span>.</span><br></pre></td></tr></table></figure>

<p><strong>删除远程分支</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin -d branchname</span><br></pre></td></tr></table></figure>




<h1 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h1><p>Git给历史中的某次提交打上标签，以示重要。<br>标签指的是某个分支某个特定时间节点的状态。（就像是打了一份快照）</p>
<p><strong>查看已有标签</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出已有标签</span></span><br><span class="line">git tag</span><br><span class="line">git show tag</span><br></pre></td></tr></table></figure>
<p><strong>创建标签</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git tag tagname</span><br><span class="line">git tag tagname -m message</span><br><span class="line"><span class="comment"># 举例</span></span><br><span class="line">git tag v1.0 -m <span class="string">&#x27;finally a stable release&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>将标签推送到远程仓库</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 推送某个标签</span></span><br><span class="line">git push origin vxx</span><br><span class="line"><span class="comment"># 推送所有不在remote的标签</span></span><br><span class="line">git push origin --tags</span><br></pre></td></tr></table></figure>

<p>实操</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取所有版本</span></span><br><span class="line">git fetch --all --tags</span><br><span class="line"><span class="comment"># 查看有哪些版本</span></span><br><span class="line">git tag</span><br><span class="line"><span class="comment"># 创建某个版本的新的分支并切换过去</span></span><br><span class="line">git checkout tags/v1.0 -b v1.0-branch</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://git-scm.com/book/zh/v2/Git-%E5%9F%BA%E7%A1%80-%E6%89%93%E6%A0%87%E7%AD%BE">Git-基础-打标签</a></p>
<h1 id="命令拾遗"><a href="#命令拾遗" class="headerlink" title="命令拾遗"></a>命令拾遗</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看工作区和暂存区的文件</span></span><br><span class="line">git ls-files</span><br></pre></td></tr></table></figure>

<p>删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">rm</span> file</span><br></pre></td></tr></table></figure>
<p><code>git rm</code>和<code>rm</code>的区别很多，网上讲的也都是其中的一个方面，不细讲了，最好自己试试。</p>
<p>查看日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/07/Sdu-Devops-02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SongyangJi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JsyBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | JsyBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/07/Sdu-Devops-02/" class="post-title-link" itemprop="url">使用Jenkins的pipeline实现CI/CD</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-07 21:00:00" itemprop="dateCreated datePublished" datetime="2022-05-07T21:00:00+08:00">2022-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-06-08 19:01:34" itemprop="dateModified" datetime="2022-06-08T19:01:34+08:00">2022-06-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h1><h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><h3 id="安装Pipeline插件"><a href="#安装Pipeline插件" class="headerlink" title="安装Pipeline插件"></a>安装Pipeline插件</h3><p>在你想创建一条流水线的时候，有可能发现并没有这个UI入口，原因是还没有下载相关插件，所以可以下载插件****，这是一整套和流水线相关的插件。（还有 BlueOcean等其他流水线相关的插件，这里先不使用，只使用classic的pipeline）。</p>
<p>下载完记得重启<code>docker-compose restart</code>。</p>
<h2 id="创建流水线"><a href="#创建流水线" class="headerlink" title="创建流水线"></a>创建流水线</h2><h3 id="Jenkinsfile模板"><a href="#Jenkinsfile模板" class="headerlink" title="Jenkinsfile模板"></a>Jenkinsfile模板</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Stage 1: Fetch code from git&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Stage 1: Fetch code from git -- SUCCESS&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(&#x27;Stage 2: Build the project using maven&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Stage 2: Build the project using maven -- SUCCESS&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(&#x27;Stage 3: Make a custom image using docker&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Stage 3: Make a custom image using docker -- SUCCESS&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(&#x27;Stage 4: Push image to Harbor&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Stage 4: Push image to Harbor -- SUCCESS&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(&#x27;Stage 5: Publish over SSH&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;Stage 5: Publish over SSH -- SUCCESS&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="从GitLab拉取代码"><a href="#从GitLab拉取代码" class="headerlink" title="从GitLab拉取代码"></a>从GitLab拉取代码</h2><p>流水线片段脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checkout([$class: &#x27;GitSCM&#x27;, branches: [[name: &#x27;$&#123;branch_tag&#125;&#x27;]], extensions: [], userRemoteConfigs: [[url: &#x27;http://211.87.224.233:8929/sdu-weblab/springboot-helloworld.git&#x27;]]])</span><br></pre></td></tr></table></figure>
<p>其中<code>branch_tag</code>为git参数（此项功能需要 Git Parameter 插件）。</p>
<p>stage为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stage(&#x27;Stage 1: Fetch code from git&#x27;) &#123;</span><br><span class="line">    steps &#123;</span><br><span class="line">        checkout([$class: &#x27;GitSCM&#x27;, branches: [[name: &#x27;$&#123;branch_tag&#125;&#x27;]], extensions: [], userRemoteConfigs: [[url: &#x27;http://211.87.224.233:8929/sdu-weblab/springboot-helloworld.git&#x27;]]])</span><br><span class="line">        echo &#x27;Stage 1: Fetch code from git -- SUCCESS&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="Git-Parameter"><a href="#Git-Parameter" class="headerlink" title="Git Parameter"></a>Git Parameter</h3><p>该插件允许您在构建中分配<strong>branch, tag, pull request or revision number</strong>作为参数。</p>
<p>此插件将从你的项目中读取 GIT SCM 配置。<br>这个插件直接使用了<a target="_blank" rel="noopener" href="https://plugins.jenkins.io/git/">Git Plugin</a>和<a target="_blank" rel="noopener" href="https://plugins.jenkins.io/git-client/">Git Client Plugin</a>。</p>
<p>git 拉取分支：</p>
<p>checkout: Check out from version control</p>
<p><a target="_blank" rel="noopener" href="http://211.87.224.233:18080/">http://211.87.224.233:18080/</a></p>
<p><a target="_blank" rel="noopener" href="https://plugins.jenkins.io/git-parameter">https://plugins.jenkins.io/git-parameter</a></p>
<h3 id="使用WebHooks实现push分支自动build"><a href="#使用WebHooks实现push分支自动build" class="headerlink" title="使用WebHooks实现push分支自动build"></a>使用WebHooks实现push分支自动build</h3><p><del><a target="_blank" rel="noopener" href="http://211.87.224.233:8080/project/pipeline-springboot-helloworld">http://211.87.224.233:8080/project/pipeline-springboot-helloworld</a></del></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hook executed successfully but returned HTTP 404 &lt;!doctype html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;title&gt;HTTP Status 404 – Not Found&lt;/title&gt;&lt;style type=&quot;text/css&quot;&gt;body &#123;font-family:Tahoma,Arial,sans-serif;&#125; h1, h2, h3, b &#123;color:white;background-color:#525D76;&#125; h1 &#123;font-size:22px;&#125; h2 &#123;font-size:16px;&#125; h3 &#123;font-size:14px;&#125; p &#123;font-size:12px;&#125; a &#123;color:black;&#125; .line &#123;height:1px;background-color:#525D76;border:none;&#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP Status 404 – Not Found&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<ol>
<li>下载插件<strong>Gitlab</strong>插件</li>
<li>在gitlab上设置Jenkins里插件生成的webhook，并添加secret token。此次webhook token为<a target="_blank" rel="noopener" href="http://jenkins:8080/project/pipeline-springboot-helloworld">http://jenkins:8080/project/pipeline-springboot-helloworld</a></li>
</ol>
<h2 id="使用Jenkins容器内的Maven打包"><a href="#使用Jenkins容器内的Maven打包" class="headerlink" title="使用Jenkins容器内的Maven打包"></a>使用Jenkins容器内的Maven打包</h2><p>打包命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;MAVEN_HOME&#125;/bin/mvn clean package -Dmaven.test.skip=<span class="literal">true</span> <span class="comment"># 容器内的$&#123;MAVEN_HOME&#125;,不是宿主机的,在这里为/opt/maven</span></span></span><br></pre></td></tr></table></figure>



<p>片段生成器生成的语句:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh &#x27;/opt/maven/bin/mvn clean package -Dmaven.test.skip=true&#x27;</span><br></pre></td></tr></table></figure>





<p>stage为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stage(&#x27;Stage 2: Build the project using maven&#x27;) &#123;</span><br><span class="line">    steps &#123;</span><br><span class="line">        // 下面两条shell作debug用，后面删去</span><br><span class="line">        sh &#x27;pwd&#x27;</span><br><span class="line">        sh &#x27;ls -al&#x27;</span><br><span class="line">        sh &#x27;/opt/maven/bin/mvn clean package -Dmaven.test.skip=true&#x27;</span><br><span class="line">        echo &#x27;Stage 2: Build the project using maven -- SUCCESS&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">+ pwd</span><br><span class="line">/var/jenkins_home/workspace/pipeline-springboot-helloworld</span><br><span class="line">[Pipeline] sh</span><br><span class="line">+ ls -al</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 5 jenkins jenkins  100 May  6 10:11 .</span><br><span class="line">drwxr-xr-x 4 jenkins jenkins   98 May  6 10:09 ..</span><br><span class="line">drwxr-xr-x 8 jenkins jenkins  210 May  6 10:13 .git</span><br><span class="line">-rw-r--r-- 1 jenkins jenkins  387 May  5 15:35 .gitignore</span><br><span class="line">-rw-r--r-- 1 jenkins jenkins 1437 May  5 15:35 pom.xml</span><br><span class="line">drwxr-xr-x 4 jenkins jenkins   42 May  5 15:35 src</span><br><span class="line">drwxr-xr-x 6 jenkins jenkins  199 May  6 10:12 target</span><br><span class="line">[Pipeline] sh</span><br><span class="line">+ /opt/maven/bin/mvn clean package -Dmaven.test.skip=true</span><br><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] -----------------------&lt; com.sduweb:helloworld &gt;------------------------</span><br><span class="line">[INFO] Building helloworld 0.0.1-SNAPSHOT</span><br><span class="line">[INFO] --------------------------------[ jar ]---------------------------------</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-clean-plugin:3.1.0:clean (default-clean) @ helloworld ---</span><br><span class="line">[INFO] Deleting /var/jenkins_home/workspace/pipeline-springboot-helloworld/target</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-resources-plugin:3.2.0:resources (default-resources) @ helloworld ---</span><br><span class="line">[INFO] Using &#x27;UTF-8&#x27; encoding to copy filtered resources.</span><br><span class="line">[INFO] Using &#x27;UTF-8&#x27; encoding to copy filtered properties files.</span><br><span class="line">[INFO] Copying 1 resource</span><br><span class="line">[INFO] Copying 0 resource</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-compiler-plugin:3.8.1:compile (default-compile) @ helloworld ---</span><br><span class="line">[INFO] Changes detected - recompiling the module!</span><br><span class="line">[INFO] Compiling 2 source files to /var/jenkins_home/workspace/pipeline-springboot-helloworld/target/classes</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-resources-plugin:3.2.0:testResources (default-testResources) @ helloworld ---</span><br><span class="line">[INFO] Not copying test resources</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-compiler-plugin:3.8.1:testCompile (default-testCompile) @ helloworld ---</span><br><span class="line">[INFO] Not compiling test sources</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-surefire-plugin:2.22.2:test (default-test) @ helloworld ---</span><br><span class="line">[INFO] Tests are skipped.</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-jar-plugin:3.2.2:jar (default-jar) @ helloworld ---</span><br><span class="line">[INFO] Building jar: /var/jenkins_home/workspace/pipeline-springboot-helloworld/target/helloworld-0.0.1-SNAPSHOT.jar</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- spring-boot-maven-plugin:2.6.4:repackage (repackage) @ helloworld ---</span><br><span class="line">[INFO] Replacing main artifact with repackaged archive</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  2.425 s</span><br><span class="line">[INFO] Finished at: 2022-05-06T10:14:04Z</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>


<p>从上面的日志输出可以得到如下结论：</p>
<ol>
<li>对于Jenkins每一个流水线项目，Jenkins都会在存储在<code>/var/jenkins_home/workspace/$&#123;projectName&#125;</code></li>
<li>从gitlab拉取代码后存储在本流水线对应的目录下<code>/var/jenkins_home/workspace/$&#123;projectName&#125;</code></li>
<li>打完jar后存储在<code>/var/jenkins_home/workspace/$&#123;projectName&#125;/target/xxx.jar</code></li>
</ol>
<blockquote>
<p><strong>跳过单元测试</strong></p>
<ul>
<li><p>-DskipTests，不执行<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B&spm=1001.2101.3001.7020">测试用例</a>，但编译测试用例类生成相应的class文件至target&#x2F;test-classes下。 </p>
</li>
<li><p>-Dmaven.test.skip&#x3D;true，不执行测试用例，也不编译测试用例类。</p>
</li>
</ul>
</blockquote>
<blockquote>
<p>参考<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6f91752f3962">https://www.jianshu.com/p/6f91752f3962</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6f57c322e50e">https://www.jianshu.com/p/6f57c322e50e</a></p>
</blockquote>
<h2 id="使用Jenkins容器内的Docker制作自定义镜像"><a href="#使用Jenkins容器内的Docker制作自定义镜像" class="headerlink" title="使用Jenkins容器内的Docker制作自定义镜像"></a>使用Jenkins容器内的Docker制作自定义镜像</h2><p>pwd: &#x2F;var&#x2F;jenkins_home&#x2F;workspace&#x2F;${projectName}<br>&#x2F;target&#x2F;xxx.jar</p>
<p>Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">ARG</span> JarFileName</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$&#123;JarFileName&#125;</span> /opt/weblab/</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/weblab/</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> java -jar <span class="variable">$&#123;JarFileName&#125;</span></span></span><br></pre></td></tr></table></figure>



<p><del>执行shell</del></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp -r /opt/docker_workdir ./</span><br><span class="line">cp ./target/*.jar ./docker_workdir</span><br><span class="line">docker build -t $&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125; ./docker_workdir --build-arg JarFileName=$(ls target -l | grep jar$ | awk &#x27;&#123;print $9&#125;&#x27;)</span><br></pre></td></tr></table></figure>

<p><del>流水线片段</del></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sh &#x27;&#x27;&#x27;cp -r /opt/docker_workdir ./</span><br><span class="line">cp ./target/*.jar ./docker_workdir</span><br><span class="line">docker build -t $&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125; ./docker_workdir --build-arg JarFileName=$(ls target -l | grep jar$ | awk \&#x27;&#123;print $9&#125;\&#x27;)&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>



<p><del>stage: 为</del></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stage(&#x27;Stage 3: Make a custom image using docker&#x27;) &#123;</span><br><span class="line">    steps &#123;</span><br><span class="line">        sh &#x27;&#x27;&#x27;</span><br><span class="line">        cp -r /opt/docker_workdir ./</span><br><span class="line">        cp ./target/*.jar ./docker_workdir</span><br><span class="line">        docker build -t $&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125; ./docker_workdir --build-arg JarFileName=$(ls target -l | grep jar$ | awk \&#x27;&#123;print $9&#125;\&#x27;)</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        echo &#x27;Stage 3: Make a custom image using docker -- SUCCESS&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p>build_image.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp -r /opt/docker_workdir ./</span><br><span class="line">cp ./target/*.jar ./docker_workdir</span><br><span class="line">jarFileName=$(ls *.jar)</span><br><span class="line">echo &quot;jar is $&#123;jarFileName&#125;&quot;</span><br><span class="line">docker build -t $&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125; ./docker_workdir --build-arg  JarFileName=&quot;$&#123;jarFileName&#125;&quot;</span><br></pre></td></tr></table></figure>











<h2 id="将自定义镜像推送到Harbor"><a href="#将自定义镜像推送到Harbor" class="headerlink" title="将自定义镜像推送到Harbor"></a>将自定义镜像推送到Harbor</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login -u admin -p admin $HARBOR_URL</span><br></pre></td></tr></table></figure>



<p>Jenkinsfile:</p>
<p>增加以下环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    </span><br><span class="line">		environment &#123;</span><br><span class="line">        harbor_user = &#x27;admin&#x27;</span><br><span class="line">        harbor_password = &#x27;admin&#x27;</span><br><span class="line">        harbor_url = &#x27;211.87.224.233:8930&#x27;</span><br><span class="line">        harbor_repo = &#x27;sdu-weblab&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    // ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Shell</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker login -u $&#123;harborUser&#125; -p $&#123;harborPassword&#125; $&#123;harbor_url&#125;</span><br><span class="line">docker tag $&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125; $&#123;harbor_url&#125;/$&#123;harbor_repo&#125;/$&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125;</span><br><span class="line">docker rmi $(docker images -f &quot;dangling=true&quot; -q) -f</span><br><span class="line">docker push $&#123;harbor_url&#125;/$&#123;harbor_repo&#125;/$&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125;</span><br></pre></td></tr></table></figure>



<p><del>pipeline script:</del></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sh &#x27;&#x27;&#x27;</span><br><span class="line">    docker login -u $&#123;harborUser&#125; -p $&#123;harborPassword&#125; $&#123;harbor_url&#125;</span><br><span class="line">    docker tag $&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125; $&#123;harbor_url&#125;/$&#123;harbor_repo&#125;/$&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125;</span><br><span class="line">    docker rmi $(docker images -f &quot;dangling=true&quot; -q) -f</span><br><span class="line">    docker push $&#123;harbor_url&#125;/$&#123;harbor_repo&#125;/$&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125;</span><br><span class="line"> &#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>



<p><del>stage为：</del></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stage(&#x27;Stage 4: Push image to Harbor&#x27;) &#123;</span><br><span class="line">    steps &#123;</span><br><span class="line">        sh &#x27;&#x27;&#x27;</span><br><span class="line">            docker login -u $&#123;harborUser&#125; -p $&#123;harborPassword&#125; $&#123;harbor_url&#125;</span><br><span class="line">            docker tag $&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125; $&#123;harbor_url&#125;/$&#123;harbor_repo&#125;/$&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125;</span><br><span class="line">            docker rmi $(docker images -f &quot;dangling=true&quot; -q) -f</span><br><span class="line">            docker push $&#123;harbor_url&#125;/$&#123;harbor_repo&#125;/$&#123;JOB_NAME&#125;:$&#123;branch_tag##*/&#125;</span><br><span class="line">         &#x27;&#x27;&#x27;</span><br><span class="line">        echo &#x27;Stage 4: Push image to Harbor -- SUCCESS&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><del>改为执行本地的脚本。</del></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">harbor_user=$1</span><br><span class="line">harbor_password=$2</span><br><span class="line">harbor_url=$3</span><br><span class="line">harbor_repo=$4</span><br><span class="line">project=$5</span><br><span class="line">branch_tag=$6</span><br><span class="line"></span><br><span class="line">image_name=$&#123;harbor_url&#125;/$&#123;harbor_repo&#125;/$&#123;project&#125;:$&#123;branch_tag##*/&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除和镜像关联的容器(正常情况不会有，但这里是单机部署)</span></span><br><span class="line">container_id=$(docker ps -a | grep &quot;$&#123;image_name&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">if [ &quot;$&#123;container_id&#125;&quot; != &quot;&quot; ] ; then</span><br><span class="line">  echo &quot;Container $&#123;container_id&#125; of $&#123;image_name&#125; is running, now try to kill it...&quot;</span><br><span class="line">  docker stop &quot;$container_id&quot;</span><br><span class="line">  docker rm &quot;$container_id&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">todo 这样做其实还有是问题的，就是上面的 container_id 可能会有多个</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">shellcheck <span class="built_in">disable</span>=SC2086</span></span><br><span class="line">docker login -u &quot;$&#123;harbor_user&#125;&quot; -p &quot;$&#123;harbor_password&#125;&quot; $&#123;harbor_url&#125;</span><br><span class="line"></span><br><span class="line">docker tag &quot;$&#123;project&#125;&quot;:&quot;$&#123;branch_tag##*/&#125;&quot; &quot;$&#123;image_name&#125;&quot;</span><br><span class="line">docker rmi $(docker images -f &quot;dangling=true&quot; -q) -f</span><br><span class="line">docker push image_name</span><br></pre></td></tr></table></figure>



<p>Jenkins端shell：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/docker_workdir/push_to_harbor.sh $harbor_user $harbor_password $harbor_url $harbor_repo $JOB_NAME $branch_tag</span><br></pre></td></tr></table></figure>

<p>流水线片段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh &#x27;/opt/docker_workdir/push_to_harbor.sh $harbor_user $harbor_password $harbor_url $harbor_repo $JOB_NAME $branch_tag&#x27;</span><br></pre></td></tr></table></figure>







<p>其中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除悬挂镜像</span></span><br><span class="line">docker rmi $(docker images -f &quot;dangling=true&quot; -q) </span><br></pre></td></tr></table></figure>

<blockquote>
<p><em>docker中的none:none镜像是怎么回事？</em><br><a target="_blank" rel="noopener" href="https://projectatomic.io/blog/2015/07/what-are-docker-none-none-images/">https://projectatomic.io/blog/2015/07/what-are-docker-none-none-images/</a></p>
</blockquote>
<p>用 go 改写：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;flag&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/api/types&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/client&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	harborUser     <span class="type">string</span></span><br><span class="line">	harborPassword <span class="type">string</span></span><br><span class="line">	harborUrl      <span class="type">string</span></span><br><span class="line">	harborRepo     <span class="type">string</span></span><br><span class="line">	project        <span class="type">string</span></span><br><span class="line">	version        <span class="type">string</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	logFileName <span class="type">string</span></span><br><span class="line">	logFile     *os.File</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">	logFileName = time.Now().Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>) + <span class="string">&quot;[push_to_harbor].log&quot;</span></span><br><span class="line">	logFile, err = os.OpenFile(logFileName, os.O_RDWR|os.O_CREATE|os.O_APPEND, <span class="number">0644</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.SetOutput(logFile)</span><br><span class="line">	log.SetPrefix(<span class="string">&quot;[sdu-weblab-deploy]&quot;</span>)</span><br><span class="line">	log.SetFlags(log.LstdFlags | log.Lshortfile | log.LUTC)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	flag.StringVar(&amp;harborUser, <span class="string">&quot;harbor_User&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;harborPassword, <span class="string">&quot;harbor_password&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;harborUrl, <span class="string">&quot;harbor_url&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;harborRepo, <span class="string">&quot;harbor_repo&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;project, <span class="string">&quot;project&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;version, <span class="string">&quot;version&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(harborUser) == <span class="number">0</span> || <span class="built_in">len</span>(harborPassword) == <span class="number">0</span> || <span class="built_in">len</span>(harborUrl) == <span class="number">0</span> ||</span><br><span class="line">		<span class="built_in">len</span>(harborRepo) == <span class="number">0</span> || <span class="built_in">len</span>(project) == <span class="number">0</span> || <span class="built_in">len</span>(version) == <span class="number">0</span> &#123;</span><br><span class="line">		log.Fatal(<span class="string">&quot;key args missing&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">&quot;Notice: harbor_url=%s, harbor_repo=%s, project=%s, version=%s&quot;</span>,</span><br><span class="line">		harborUrl, harborRepo, project, version)</span><br><span class="line"></span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	cli, err := client.NewClientWithOpts(client.FromEnv, client.WithAPIVersionNegotiation())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;New docker client fail, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	version = getRealVersion(version)</span><br><span class="line">	imageName := getHarborImageName(harborUrl, harborRepo, project, version)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 删除和镜像关联的容器(正常情况不会有，但这里是单机部署)</span></span><br><span class="line">	<span class="comment">// 1. check existing containers and remove it if so</span></span><br><span class="line">	log.Printf(<span class="string">&quot;Check if container of %s exists...\n&quot;</span>, imageName)</span><br><span class="line">	containers, err := cli.ContainerList(ctx, types.ContainerListOptions&#123;All: <span class="literal">true</span>&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;List all containers fail, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> timeOut = time.Second</span><br><span class="line">	<span class="keyword">for</span> _, c := <span class="keyword">range</span> containers &#123;</span><br><span class="line">		<span class="keyword">if</span> c.Image == imageName &#123;</span><br><span class="line">			cid := c.ID</span><br><span class="line">			err = cli.ContainerStop(ctx, cid, &amp;timeOut)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;Warning: container.ID=%s stop failed&quot;</span>, cid)</span><br><span class="line">			&#125;</span><br><span class="line">			err = cli.ContainerRemove(ctx, cid, types.ContainerRemoveOptions&#123;Force: <span class="literal">true</span>&#125;)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;Container.ID=%s remove failed&quot;</span>, cid)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. tag by the rule of harbor</span></span><br><span class="line">	<span class="comment">// 2.1 check and remove outdated version images</span></span><br><span class="line">	log.Printf(<span class="string">&quot;Check if image %s exists...\n&quot;</span>, imageName)</span><br><span class="line">	imageList, err := cli.ImageList(ctx, types.ImageListOptions&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;List all images fail, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, image := <span class="keyword">range</span> imageList &#123;</span><br><span class="line">		<span class="keyword">for</span> _, repoTag := <span class="keyword">range</span> image.RepoTags &#123;</span><br><span class="line">			<span class="keyword">if</span> repoTag == imageName &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;Image=%s exists, next to remove it&quot;</span>, image.ID)</span><br><span class="line">				cli.ImageRemove(ctx, image.ID, types.ImageRemoveOptions&#123;</span><br><span class="line">					Force: <span class="literal">true</span>,</span><br><span class="line">				&#125;)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 2.2 tag</span></span><br><span class="line">	sourceImageName := getSourceImageName(harborRepo, project, version)</span><br><span class="line">	err = cli.ImageTag(ctx, sourceImageName, imageName)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;image tag fail, err=%v&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// todo docker rmi $(docker images -f &quot;dangling=true&quot; -q) -f</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. push image to harbor</span></span><br><span class="line">	log.Printf(<span class="string">&quot;Push image %s to Harbor...\n&quot;</span>, imageName)</span><br><span class="line">	_, err = cli.RegistryLogin(ctx, types.AuthConfig&#123;</span><br><span class="line">		<span class="comment">// todo security</span></span><br><span class="line">		Username:      <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">		Password:      <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">		ServerAddress: harborUrl,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;push to harbor fail, err=%v&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	out, err := cli.ImagePush(ctx, imageName, types.ImagePushOptions&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;Pulling image failed, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> out.Close()</span><br><span class="line">	io.Copy(logFile, out)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// remove possible &quot;/&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getRealVersion</span><span class="params">(rawVersion <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	parts := strings.Split(rawVersion, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(parts) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> parts[<span class="built_in">len</span>(parts)<span class="number">-1</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> version</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getSourceImageName</span><span class="params">(team, project, version <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%s/%s/%s:%s&quot;</span>, team, harborRepo, project, version)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getHarborImageName</span><span class="params">(harborUrl, harborRepo, project, version <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%s/%s/%s:%s&quot;</span>, harborUrl, harborRepo, project, version)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="通过SSH通知目标服务器部署"><a href="#通过SSH通知目标服务器部署" class="headerlink" title="通过SSH通知目标服务器部署"></a>通过SSH通知目标服务器部署</h2><p>这里使用<strong>Publish Over SSH</strong>。</p>
<p><strong>部署端</strong>的执行脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">harbor_url=$1</span><br><span class="line">harbor_repo=$2</span><br><span class="line">project=$3</span><br><span class="line">version=$4</span><br><span class="line">container_port=$5</span><br><span class="line"></span><br><span class="line">image_name=$harbor_url/$harbor_repo/$project:$version</span><br><span class="line"></span><br><span class="line">container_id=$(docker ps -a | grep &quot;$&#123;image_name&#125;&quot; | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">echo &quot;Check if container of $&#123;image_name&#125; exists...&quot;</span><br><span class="line">if [ &quot;$&#123;container_id&#125;&quot; != &quot;&quot; ] ; then</span><br><span class="line">  echo &quot;Container $&#123;container_id&#125; of $&#123;image_name&#125; is running, now try to kill it...&quot;</span><br><span class="line">  docker stop &quot;$container_id&quot;</span><br><span class="line">  docker rm &quot;$container_id&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">old_image=$(docker images | grep &quot;$&#123;image_name&#125;&quot;)</span><br><span class="line"></span><br><span class="line">if [ &quot;$&#123;old_image&#125;&quot; != &quot;&quot; ] ; then</span><br><span class="line">  echo &quot;Image $image_name exists, now try to remove it&quot;</span><br><span class="line">  docker rmi &quot;$image_name&quot; -f</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;Try to login Harbor...&quot;</span><br><span class="line">docker login -u amdin -p admin &quot;$harbor_url&quot;</span><br><span class="line">echo &quot;Login Harbor successfully.&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;Try to pull $image_name from Harbor...&quot;</span><br><span class="line">docker pull &quot;$&#123;image_name&#125;&quot;</span><br><span class="line">echo &quot;Pull image $&#123;image_name&#125; from Harbor successfully.&quot;</span><br><span class="line"></span><br><span class="line">docker run -d -p &quot;$container_port&quot; --name &quot;$harbor_repo.$project.$version&quot; &quot;$image_name&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;Deploy service successfully.&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上脚本执行了如下事情：</p>
<ol>
<li>检查旧版本的容器是否在运行，如果有停止并删除；</li>
<li>检查旧镜像是否存在，如果有删除；</li>
<li>登录私服Harbor</li>
<li>拉取最新的镜像</li>
<li>运行容器</li>
</ol>
<p><strong>发布端（Jenkins）</strong>的执行脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd deploy &amp;&amp; touch deploy.log &amp;&amp; /home/jsy/devops/docker_workdir/deploy.sh $harbor_url $harbor_repo $JOB_NAME $branch_tag $container_port &gt; deploy.log</span><br></pre></td></tr></table></figure>



<p>测试一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd deploy &amp;&amp; touch deploy.log &amp;&amp; /home/jsy/devops/docker_workdir/deploy.sh 211.87.224.233:8930 sdu-weblab springboot-helloworld origin/master 8080 &gt; deploy.log</span><br></pre></td></tr></table></figure>





<p>使用sshPublisher生成流水线脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshPublisher(publishers: [sshPublisherDesc(configName: &#x27;sdu-weblab-local-machine&#x27;, transfers: [sshTransfer(cleanRemote: false, excludes: &#x27;&#x27;, execCommand: &quot;cd deploy &amp;&amp; touch deploy.log &amp;&amp; /home/jsy/devops/docker_workdir/deploy.sh $harbor_url $harbor_repo $JOB_NAME $branch_tag $container_port &gt; deploy.log&quot;, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: &#x27;[, ]+&#x27;, remoteDirectory: &#x27;&#x27;, remoteDirectorySDF: false, removePrefix: &#x27;&#x27;, sourceFiles: &#x27;&#x27;)], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])</span><br></pre></td></tr></table></figure>



<p>stage为</p>
<pre><code>        stage(&#39;Stage 5: Publish over SSH&#39;) &#123;
            steps &#123;
                sshPublisher(publishers: [sshPublisherDesc(configName: &#39;sdu-weblab-local-machine&#39;, transfers: [sshTransfer(cleanRemote: false, excludes: &#39;&#39;, execCommand: &quot;cd deploy &amp;&amp; touch deploy.log &amp;&amp; /home/jsy/devops/docker_workdir/deploy.sh $harbor_url $harbor_repo $JOB_NAME $branch_tag $container_port &gt; deploy.log&quot;, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: &#39;[, ]+&#39;, remoteDirectory: &#39;&#39;, remoteDirectorySDF: false, removePrefix: &#39;&#39;, sourceFiles: &#39;&#39;)], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])
                echo &#39;Stage 5: Publish over SSH -- SUCCESS&#39;
            &#125;
        &#125;
</code></pre>
<h2 id="通过SSH通知目标服务器部署（部署端使用go部署）"><a href="#通过SSH通知目标服务器部署（部署端使用go部署）" class="headerlink" title="通过SSH通知目标服务器部署（部署端使用go部署）"></a>通过SSH通知目标服务器部署（部署端使用go部署）</h2><h3 id="部署程序"><a href="#部署程序" class="headerlink" title="部署程序"></a>部署程序</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;flag&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;os/exec&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/api/types&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/api/types/container&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/client&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/go-connections/nat&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	DefaultVersion       = <span class="string">&quot;master&quot;</span></span><br><span class="line">	MonitorProgrammeName = <span class="string">&quot;monitor&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	harborUrl     <span class="type">string</span></span><br><span class="line">	harborRepo    <span class="type">string</span></span><br><span class="line">	project       <span class="type">string</span></span><br><span class="line">	version       <span class="type">string</span></span><br><span class="line">	containerPort <span class="type">int</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	logFileName <span class="type">string</span></span><br><span class="line">	containerID <span class="type">string</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	logFileName = time.Now().Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>) + <span class="string">&quot;.log&quot;</span></span><br><span class="line">	logFile, err := os.OpenFile(logFileName, os.O_RDWR|os.O_CREATE|os.O_APPEND, <span class="number">0644</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.SetOutput(logFile)</span><br><span class="line">	log.SetPrefix(<span class="string">&quot;[sdu-weblab-deploy]&quot;</span>)</span><br><span class="line">	log.SetFlags(log.LstdFlags | log.Lshortfile | log.LUTC)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	flag.StringVar(&amp;harborUrl, <span class="string">&quot;harbor_url&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;harborRepo, <span class="string">&quot;harbor_repo&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;project, <span class="string">&quot;project&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;version, <span class="string">&quot;version&quot;</span>, DefaultVersion, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.IntVar(&amp;containerPort, <span class="string">&quot;container_port&quot;</span>, <span class="number">8080</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(harborUrl) == <span class="number">0</span> || <span class="built_in">len</span>(harborRepo) == <span class="number">0</span> || <span class="built_in">len</span>(project) == <span class="number">0</span> &#123;</span><br><span class="line">		log.Fatal(<span class="string">&quot;key args missing&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">&quot;Notice: harbor_url=%s, harbor_repo=%s, project=%s, version=%s, container_port=%d&quot;</span>,</span><br><span class="line">		harborUrl, harborRepo, project, version, containerPort)</span><br><span class="line"></span><br><span class="line">	version = getBranch(version)</span><br><span class="line">	imageName := harborUrl + <span class="string">&quot;/&quot;</span> + harborRepo + <span class="string">&quot;/&quot;</span> + project + <span class="string">&quot;:&quot;</span> + version</span><br><span class="line">	log.Printf(<span class="string">&quot;Docker image name is %s&quot;</span>, imageName)</span><br><span class="line"></span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	cli, err := client.NewClientWithOpts(client.FromEnv, client.WithAPIVersionNegotiation())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;New docker client fail, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. check existing containers</span></span><br><span class="line">	log.Printf(<span class="string">&quot;Check if container of %s exists...\n&quot;</span>, imageName)</span><br><span class="line">	containers, err := cli.ContainerList(ctx, types.ContainerListOptions&#123;All: <span class="literal">true</span>&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;List all containers fail, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> timeOut = time.Second</span><br><span class="line">	<span class="keyword">for</span> _, c := <span class="keyword">range</span> containers &#123;</span><br><span class="line">		<span class="keyword">if</span> c.Image == imageName &#123;</span><br><span class="line">			cid := c.ID</span><br><span class="line">			err = cli.ContainerStop(ctx, cid, &amp;timeOut)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;Warning: container.ID=%s stop failed&quot;</span>, cid)</span><br><span class="line">			&#125;</span><br><span class="line">			err = cli.ContainerRemove(ctx, cid, types.ContainerRemoveOptions&#123;Force: <span class="literal">true</span>&#125;)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;Container.ID=%s remove failed&quot;</span>, cid)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. check outdated version images</span></span><br><span class="line">	log.Printf(<span class="string">&quot;Check if image %s exists...\n&quot;</span>, imageName)</span><br><span class="line">	imageList, err := cli.ImageList(ctx, types.ImageListOptions&#123;</span><br><span class="line">		All: <span class="literal">true</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;List all images fail, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, image := <span class="keyword">range</span> imageList &#123;</span><br><span class="line">		<span class="keyword">for</span> _, repoTag := <span class="keyword">range</span> image.RepoTags &#123;</span><br><span class="line">			<span class="keyword">if</span> repoTag == imageName &#123;</span><br><span class="line">				cli.ImageRemove(ctx, image.ID, types.ImageRemoveOptions&#123;</span><br><span class="line">					Force: <span class="literal">true</span>,</span><br><span class="line">				&#125;)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. pull image from harbor</span></span><br><span class="line">	log.Printf(<span class="string">&quot;Pull image %s from Harbor...\n&quot;</span>, imageName)</span><br><span class="line">	_, err = cli.RegistryLogin(ctx, types.AuthConfig&#123;</span><br><span class="line">		<span class="comment">// todo security</span></span><br><span class="line">		Username:      <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">		Password:      <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">		ServerAddress: harborUrl,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// out 是响应输出流，可以不输出</span></span><br><span class="line">	out, err := cli.ImagePull(ctx, imageName, types.ImagePullOptions&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> out.Close()</span><br><span class="line">	io.Copy(os.Stdout, out)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4. docker run -d -p &quot;$container_port&quot; --name &quot;$harbor_repo.$project.$version&quot; &quot;$image_name&quot;</span></span><br><span class="line">	log.Printf(<span class="string">&quot;Run image %s to be contaniner...\n&quot;</span>, imageName)</span><br><span class="line">	containerName := harborRepo + <span class="string">&quot;.&quot;</span> + project + <span class="string">&quot;.&quot;</span> + version</span><br><span class="line">	containerNatPort := nat.Port(strconv.Itoa(containerPort) + <span class="string">&quot;/tcp&quot;</span>)</span><br><span class="line"></span><br><span class="line">	resp, err := cli.ContainerCreate(ctx,</span><br><span class="line">		&amp;container.Config&#123;</span><br><span class="line">			Image: imageName,</span><br><span class="line">			ExposedPorts: nat.PortSet&#123;</span><br><span class="line">				containerNatPort: <span class="keyword">struct</span>&#123;&#125;&#123;&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;, &amp;container.HostConfig&#123;</span><br><span class="line">			PublishAllPorts: <span class="literal">true</span>,</span><br><span class="line">		&#125;, <span class="literal">nil</span>, <span class="literal">nil</span>, containerName)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;Creating container failed, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err = cli.ContainerStart(ctx, resp.ID, types.ContainerStartOptions&#123;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;Starting container failed, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	containerID = resp.ID</span><br><span class="line">	log.Printf(<span class="string">&quot;Container ID = %s&quot;</span>, containerID)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// todo register to center</span></span><br><span class="line">	hostPortOfContainerPort, err := getHostPortOfContainerPort(containerID, strconv.Itoa(containerPort))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;Error: get port binding failed, err=%v&quot;</span>, err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;Container hostPort of container port is %s&quot;</span>, hostPortOfContainerPort)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="string">&quot;Deploy successfully.&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 5. run a new programme to fetch log stream and transfer it to websocket</span></span><br><span class="line">	runGoProgramme(MonitorProgrammeName)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runGoProgramme</span><span class="params">(programme <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;Next to run programme %s &quot;</span>, programme)</span><br><span class="line">	sduWeblabBinHome := os.Getenv(<span class="string">&quot;SDU_WEBLAB_BIN_HOME&quot;</span>)</span><br><span class="line">	s := fmt.Sprintf(<span class="string">&quot;%s/%s --logFileName=%s --containerID=%s&quot;</span>, sduWeblabBinHome, programme, logFileName, containerID)</span><br><span class="line">	log.Printf(<span class="string">&quot;Shell script is %s&quot;</span>, s)</span><br><span class="line">	err := exec.Command(<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, s).Start()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;Fail to run programe %s, err=%v&quot;</span>, programme, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getBranch</span><span class="params">(repoBranch <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	parts := strings.Split(repoBranch, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(parts) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> parts[<span class="built_in">len</span>(parts)<span class="number">-1</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> DefaultVersion</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getHostPortOfContainerPort</span><span class="params">(containerId <span class="type">string</span>, containerPort <span class="type">string</span>)</span></span> (port <span class="type">string</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	shell := <span class="string">&quot;docker port &quot;</span> + containerId + <span class="string">&quot; | grep &quot;</span> + containerPort + <span class="string">&quot; | awk &#x27;&#123;print $3&#125;&#x27;&quot;</span></span><br><span class="line">	output, err := exec.Command(<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, shell).Output()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	shellOut := <span class="type">string</span>(output)</span><br><span class="line">	parts := strings.Split(shellOut, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(parts) == <span class="number">0</span> &#123;</span><br><span class="line">		err = fmt.Errorf(<span class="string">&quot;containerPort=%s has no bindings&quot;</span>, containerPort)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	ipPort := parts[<span class="number">0</span>]</span><br><span class="line">	splits := strings.Split(ipPort, <span class="string">&quot;:&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(splits) != <span class="number">2</span> &#123;</span><br><span class="line">		err = errors.New(<span class="string">&quot;invalid format&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	port = splits[<span class="number">1</span>]</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="监控程序"><a href="#监控程序" class="headerlink" title="监控程序"></a>监控程序</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bufio&quot;</span></span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;flag&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/api/types&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/client&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gorilla/websocket&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	logFileName <span class="type">string</span></span><br><span class="line">	containerID <span class="type">string</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	logOut   io.ReadCloser</span><br><span class="line">	upgrader = websocket.Upgrader&#123;</span><br><span class="line">		CheckOrigin: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;,</span><br><span class="line">	&#125; <span class="comment">// use default options</span></span><br><span class="line">	conn       *websocket.Conn</span><br><span class="line">	listenPort <span class="type">int</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitLog</span><span class="params">()</span></span> &#123;</span><br><span class="line">	logFile, err := os.OpenFile(logFileName, os.O_RDWR|os.O_CREATE|os.O_APPEND, <span class="number">0644</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.SetOutput(logFile)</span><br><span class="line">	log.SetPrefix(<span class="string">&quot;[sdu-weblab-deploy]&quot;</span>)</span><br><span class="line">	log.SetFlags(log.LstdFlags | log.Lshortfile | log.LUTC)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// fetch log stream and transfer it to websocket</span></span><br><span class="line">	flag.StringVar(&amp;logFileName, <span class="string">&quot;logFileName&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;containerID, <span class="string">&quot;containerID&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(logFileName) == <span class="number">0</span> || <span class="built_in">len</span>(containerID) == <span class="number">0</span> &#123;</span><br><span class="line">		log.Fatal(<span class="string">&quot;key args missing&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// init log settings</span></span><br><span class="line">	InitLog()</span><br><span class="line"></span><br><span class="line">	log.Printf(<span class="string">&quot;Fetch log stream and transfer it to websocket...\n&quot;</span>)</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">	cli, err := client.NewClientWithOpts(client.FromEnv, client.WithAPIVersionNegotiation())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;New docker client fail, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	options := types.ContainerLogsOptions&#123;</span><br><span class="line">		ShowStdout: <span class="literal">true</span>,</span><br><span class="line">		ShowStderr: <span class="literal">true</span>,</span><br><span class="line">		Follow:     <span class="literal">true</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	logOut, err = cli.ContainerLogs(ctx, containerID, options) <span class="comment">// remote</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;Get log of container failed, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:0&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;Net listen failed, err=%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	listenPort = listener.Addr().(*net.TCPAddr).Port</span><br><span class="line">	<span class="comment">// todo register to center</span></span><br><span class="line">	log.Printf(<span class="string">&quot;Websocket port is %d&quot;</span>, listenPort)</span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/logs&quot;</span>, socketHandler)</span><br><span class="line">	log.Fatal(http.Serve(listener, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">socketHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Upgrade our raw HTTP connection to a websocket based one</span></span><br><span class="line">	_conn, err := upgrader.Upgrade(w, r, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Print(<span class="string">&quot;Error during connection upgradation:&quot;</span>, err)</span><br><span class="line">		os.Exit(<span class="number">3</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	conn = _conn</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">	reader := bufio.NewReader(logOut)</span><br><span class="line">	<span class="comment">// The event loop</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		message, err := reader.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">				exitAndNotifyPeer(message, <span class="number">0</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			exitAndNotifyPeer(<span class="string">&quot;\n&quot;</span>, <span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//log.Printf(&quot;Log read is: %s&quot;, message)</span></span><br><span class="line">		err = conn.WriteMessage(websocket.TextMessage, []<span class="type">byte</span>(message))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;Error during message writing: &quot;</span>, err)</span><br><span class="line">			os.Exit(<span class="number">2</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">exitAndNotifyPeer</span><span class="params">(msg <span class="type">string</span>, exitCode <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	conn.WriteMessage(websocket.CloseMessage, []<span class="type">byte</span>(msg))</span><br><span class="line">	os.Exit(exitCode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="构建脚本"><a href="#构建脚本" class="headerlink" title="构建脚本"></a>构建脚本</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">jsy@wzai:~/devops/docker_workdir$ tree</span><br><span class="line">.</span><br><span class="line">├── deploy</span><br><span class="line">│   ├── go.mod</span><br><span class="line">│   ├── go.sum</span><br><span class="line">│   ├── main.go</span><br><span class="line">│   └── output</span><br><span class="line">│       └── bin</span><br><span class="line">│           └── deploy</span><br><span class="line">├── monitor</span><br><span class="line">│   ├── go.mod</span><br><span class="line">│   ├── go.sum</span><br><span class="line">│   ├── main.go</span><br><span class="line">│   └── output</span><br><span class="line">│       └── bin</span><br><span class="line">│           └── monitor</span><br></pre></td></tr></table></figure>

<p><code>go build</code></p>
<p>首次构建</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/devops/docker_workdir/</span><br><span class="line">cd deploy &amp;&amp; go mod tidy &amp;&amp; mkdir -p output/bin &amp;&amp; go build -o output/bin/deploy</span><br><span class="line">cd monitor &amp;&amp; go mod tidy &amp;&amp; mkdir -p output/bin &amp;&amp; go build -o output/bin/monitor</span><br></pre></td></tr></table></figure>

<p>后面更新</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~/devops/docker_workdir/</span><br><span class="line">cd deploy &amp;&amp; go mod tidy &amp;&amp; go build -o output/bin/deploy</span><br><span class="line">cd ~/devops/docker_workdir/</span><br><span class="line">cd monitor &amp;&amp; go mod tidy &amp;&amp; go build -o output/bin/monitor</span><br></pre></td></tr></table></figure>



<p>构建或更新软链接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -f -s /home/jsy/devops/docker_workdir/deploy/output/bin/deploy /opt/sduweblab/bin/deploy</span><br><span class="line">sudo ln -f -s /home/jsy/devops/docker_workdir/monitor/output/bin/monitor /opt/sduweblab/bin/monitor</span><br></pre></td></tr></table></figure>





<p><del>更新产物</del></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd ~/devops/docker_workdir/</span><br><span class="line">cd deploy &amp;&amp; go mod tidy &amp;&amp; go build -o output/bin/deploy</span><br><span class="line">cd ~/devops/docker_workdir/</span><br><span class="line">cd monitor &amp;&amp; go mod tidy &amp;&amp; go build -o output/bin/monitor</span><br><span class="line">sudo ln -f -s /home/jsy/devops/docker_workdir/deploy/output/bin/deploy /opt/sduweblab/bin/deploy</span><br><span class="line">sudo ln -f -s /home/jsy/devops/docker_workdir/monitor/output/bin/monitor /opt/sduweblab/bin/monitor</span><br></pre></td></tr></table></figure>


<p>更新产物（推送镜像到harbor也使用go改写）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /opt/sduweblab/bin/deploy</span><br><span class="line">sudo rm /opt/sduweblab/bin/monitor</span><br><span class="line">sudo rm /opt/sduweblab/bin/push_to_harbor</span><br><span class="line">cd ~/devops/docker_workdir/</span><br><span class="line">cd deploy &amp;&amp; go mod tidy &amp;&amp; go build -o output/bin/deploy</span><br><span class="line">cd ~/devops/docker_workdir/</span><br><span class="line">cd monitor &amp;&amp; go mod tidy &amp;&amp; go build -o output/bin/monitor</span><br><span class="line">cd ~/devops/docker_workdir/</span><br><span class="line">cd push_to_harbor &amp;&amp; go mod tidy &amp;&amp; go build -o output/bin/push_to_harbor</span><br><span class="line">sudo cp /home/jsy/devops/docker_workdir/deploy/output/bin/deploy /opt/sduweblab/bin/deploy</span><br><span class="line">sudo cp /home/jsy/devops/docker_workdir/monitor/output/bin/monitor /opt/sduweblab/bin/monitor</span><br><span class="line">sudo cp /home/jsy/devops/docker_workdir/push_to_harbor/output/bin/push_to_harbor /opt/sduweblab/bin/push_to_harbor</span><br><span class="line">cd</span><br></pre></td></tr></table></figure>





<p>原先的shell换成go程序即可。</p>
<p>测试脚本：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd deploy &amp;&amp; /opt/sduweblab/bin/deploy --harbor_url=<span class="number">211.87</span><span class="number">.224</span><span class="number">.233</span>:<span class="number">8930</span> --harbor_repo=sdu-weblab --project=springboot-helloworld --version=origin/master --container_port=<span class="number">8080</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/06/Sdu-Devops-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SongyangJi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JsyBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | JsyBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/06/Sdu-Devops-01/" class="post-title-link" itemprop="url">安装Docker、Harbor、Jenkins、Gitlab</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-06 21:00:00" itemprop="dateCreated datePublished" datetime="2022-05-06T21:00:00+08:00">2022-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-05-29 15:40:03" itemprop="dateModified" datetime="2022-05-29T15:40:03+08:00">2022-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="系统平台信息"><a href="#系统平台信息" class="headerlink" title="系统平台信息"></a>系统平台信息</h1><p>OS:  Linux Mint 20.3 Una</p>
<p>Kernel Release: 5.13.0-35-generic</p>
<p>Hardware Platform: x86_64</p>
<p>CPU Model Name:  Intel(R) Xeon(R) CPU E5-2680 v3 @ 2.50GHz</p>
<p>CPU Cores: 48</p>
<p>Main Memory: 125GB</p>
<p>IP: 211.87.224.233</p>
<h1 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h1><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p>version 20.10.14</p>
<p>旧版本的 Docker </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br></pre></td></tr></table></figure>



<h4 id="设置存储库"><a href="#设置存储库" class="headerlink" title="设置存储库"></a>设置存储库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line">sudo apt-get install \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>



<p>这里没有安装 docker-compose</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>



<p>apt-cache madison docker-ce</p>
<p>version &#x3D; <code>5:20.10.16~3-0~ubuntu-focal</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install docker-ce=5:20.10.16~3-0~ubuntu-focal docker-ce-cli=5:20.10.16~3-0~ubuntu-focal containerd.io</span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#1.配置阿里云的gpg</span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"></span><br><span class="line">#2.配置阿里云的docker镜像</span><br><span class="line">sudo add-apt-repository &quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</span><br><span class="line"></span><br><span class="line">#3.执行安装命令</span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>






<h3 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker-Compose"></a>Docker-Compose</h3><p>docker-compose version 1.29.2</p>
<p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p>加上可执行权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/bin/docker-compose</span><br></pre></td></tr></table></figure>



<h2 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h2><p>go version go1.17.7 linux&#x2F;amd6</p>
<h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><p>openjdk version “1.8.0_312”</p>
<p>path: &#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-8-openjdk-amd64</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-alternatives --config java</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">output</span></span><br><span class="line">There are 3 choices for the alternative java (providing /usr/bin/java).</span><br><span class="line"></span><br><span class="line">  Selection    Path                                            Priority   Status</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">* 0            /usr/lib/jvm/java-17-openjdk-amd64/bin/java      1711      auto mode</span><br><span class="line">  1            /usr/lib/jvm/java-11-openjdk-amd64/bin/java      1111      manual mode</span><br><span class="line">  2            /usr/lib/jvm/java-17-openjdk-amd64/bin/java      1711      manual mode</span><br><span class="line">  3            /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java   1081      manual mode</span><br><span class="line"></span><br><span class="line">Press &lt;enter&gt; to keep the current choice[*], or type selection number:</span><br></pre></td></tr></table></figure>

<p><code>java -version</code> 检查</p>
<h2 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h2><p>Apache Maven 3.8.5</p>
<p>path: &#x2F;opt&#x2F;apache-maven-3.8.5</p>
<ul>
<li>jdk8编译插件配置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-8<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>8<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>maven仓库源</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>Aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="Gitlab"><a href="#Gitlab" class="headerlink" title="Gitlab"></a>Gitlab</h2><p>使用docker安装 Gitlab</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search gitlab/</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /srv/gitlab &amp;&amp; echo &quot;export GITLAB_HOME=/srv/gitlab&quot; &gt;&gt; .profile &amp;&amp; source .profile</span><br></pre></td></tr></table></figure>



<p>docker-compose.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.6&#x27;</span></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">  <span class="attr">web:</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;gitlab/gitlab-ce:latest&#x27;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">sdu-weblab-gitlab</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">&#x27;211.87.224.233&#x27;</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        external_url &#x27;http://211.87.224.233:8929&#x27;</span></span><br><span class="line"><span class="string">        gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = 2224</span></span><br><span class="line"><span class="string"></span>    <span class="attr">ports:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8929:8929&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;2224:22&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;$GITLAB_HOME/config:/etc/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;$GITLAB_HOME/logs:/var/log/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;$GITLAB_HOME/data:/var/opt/gitlab&#x27;</span></span><br></pre></td></tr></table></figure>

<p>注意点:</p>
<p>external_url中的端口需要和ports映射的容器端口保持一致;</p>
<p>gitlab_rails[‘gitlab_shell_ssh_port’]要和宿主机端口保持一致。</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>构建并启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f ./docker-compose.yml up -d # 如果文件名为`docker-compose.yml`可以不指定-f</span><br></pre></td></tr></table></figure>

<p>强制重启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d --force-recreate</span><br></pre></td></tr></table></figure>



<p>重新构建并启动（反映yml的变化，一定是最新的）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose down &amp;&amp; docker-compose up -d</span><br></pre></td></tr></table></figure>





<p>注意：这个服务启动时间比较长，须等待一两分钟。</p>
<p>检查是否成功运行：浏览器访问 <a target="_blank" rel="noopener" href="http://211.87.224.233:8929/">http://211.87.224.233:8929</a>  (这个8989是映射的宿主机port，当然你可以映射成其他端口)</p>
<p>如果访问失败，注意云服务器的安全组或者firewall的端口开放情况（sudo ufw status）</p>
<h3 id="使用Gitlab"><a href="#使用Gitlab" class="headerlink" title="使用Gitlab"></a>使用Gitlab</h3><p>默认管理员账户：root</p>
<p>查看配置文件得到密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意我们已经配置好数据卷映射了</span></span><br><span class="line">sudo cat $GITLAB_HOME/config/initial_root_password</span><br></pre></td></tr></table></figure>

<p>可以再去修改一下密码（设置为： sduweblab）</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/install/docker.html">https://docs.gitlab.com/ee/install/docker.html</a></p>
<p><a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template">https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template</a></p>
</blockquote>
<h4 id="New-project-gt-Create-blank-project"><a href="#New-project-gt-Create-blank-project" class="headerlink" title="[New project]-&gt;[Create blank project]"></a>[New project]-&gt;[Create blank project]</h4><h4 id="Mac配置ssh登录"><a href="#Mac配置ssh登录" class="headerlink" title="Mac配置ssh登录"></a>Mac配置ssh登录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jisongyang@SongyangJi-MacBookAir .ssh % ssh -p 2224 -T git@211.87.224.233</span><br><span class="line">ssh: connect to host 211.87.224.233 port 2224: Connection refused</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jisongyang@SongyangJi-MacBookAir .ssh % ssh -T git@211.87.224.233</span><br><span class="line">git@211.87.224.233&#x27;s password:</span><br></pre></td></tr></table></figure>










<h2 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>jenkins: 2.346</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins/jenkins:latest</span><br></pre></td></tr></table></figure>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>docker-compse yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.6&#x27;</span></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">  <span class="attr">jenkins:</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">jenkins/jenkins:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">sdu-weblab-jenkins-latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;18080:8080&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;50000:50000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/var/jenkins_home</span> <span class="comment"># jenkins:latest 的home目录，包括插件和配置等等</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;$MAVEN_HOME:/opt/maven&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;$JAVA_HOME:/opt/java8&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/bin/docker:/usr/bin/docker</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/docker/daemon.json:/etc/docker/daemon.json</span></span><br></pre></td></tr></table></figure>

<p>由于jenkins承担了打包的任务，因此将宿主机的jdk和maven挂载上去（另一种做法是自定义一个包含jdk和maven的jenkins镜像，有待尝试）。</p>
<p>(其中有关docker的配置后面再解释)</p>
<h3 id="修改镜像源"><a href="#修改镜像源" class="headerlink" title="修改镜像源"></a>修改镜像源</h3><p>否则大概率下载插件会失败！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim data/hudson.model.UpdateCenter.xml</span><br></pre></td></tr></table></figure>



<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.1&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sites</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">site</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">site</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sites</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><p>启动之后，查看日志发现写数据卷的时候权限不够。（有可能）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod -R 777 data/</span><br></pre></td></tr></table></figure>

<p>给足data文件夹权限。(奇怪的是，docker-compose restart的时候还是要发现写权限不够)</p>
<p>检查是否启动成功，访问 <a target="_blank" rel="noopener" href="http://211.87.224.233:18080/">http://211.87.224.233:18080/</a></p>
<p><strong>进入容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it sdu-weblab-jenkins bash</span><br></pre></td></tr></table></figure>





<h3 id="登录Jenkins"><a href="#登录Jenkins" class="headerlink" title="登录Jenkins"></a>登录Jenkins</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看管理员日志密码（查看文件 or 使用docker-compose logs -f 查看日志）</span></span><br><span class="line">cat data/secrets/initialAdminPassword # 可能没有文件读权限</span><br></pre></td></tr></table></figure>



<p>admin: f991e76fb99b4e3993ccdb52a9eaa8f7</p>
<h3 id="管理插件"><a href="#管理插件" class="headerlink" title="管理插件"></a>管理插件</h3><p>入口：[Manage Jenkins]-&gt;[System Configuration]-&gt;[Manage Plugins]</p>
<p><strong>必备插件</strong></p>
<ul>
<li>Git Parameter</li>
<li>Publish Over SSH</li>
<li>Gitlab</li>
<li>Pipeline</li>
</ul>
<h3 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h3><h4 id="Manage-Jenkins-gt-Global-Tool-Configuration"><a href="#Manage-Jenkins-gt-Global-Tool-Configuration" class="headerlink" title="[Manage Jenkins]-&gt;[Global Tool Configuration]"></a>[Manage Jenkins]-&gt;[Global Tool Configuration]</h4><p>配置jdk和maven的home。<br>其中MAVEN_HOME配置为<code>/opt/maven</code>; JAVA_HOME配置为<code>/opt/java8</code>（不错这两个文件夹其实是从宿主机映射过来的，其真实路径分别为宿主机的<code>$MAVEN_HOME</code>、<code>JAVA_HOME</code>，也就是<code>/opt/apache-maven-3.8.5</code>、<code>/usr/lib/jvm/java-8-openjdk-amd64</code>）</p>
<h4 id="Manage-Jenkins-gt-Configure-System-gt-Publish-over-SSH"><a href="#Manage-Jenkins-gt-Configure-System-gt-Publish-over-SSH" class="headerlink" title="[Manage Jenkins]-&gt;[Configure System]-&gt;[Publish over SSH]"></a>[Manage Jenkins]-&gt;[Configure System]-&gt;[Publish over SSH]</h4><p>配置远程发布的机器，这里为了方便就配置本机即可。（这里在配置auth校验的时候最好使用密码校验，配置的私钥话可能因为不合规导致失败）</p>
<h3 id="在Jenkins容器内使用docker"><a href="#在Jenkins容器内使用docker" class="headerlink" title="在Jenkins容器内使用docker"></a>在Jenkins容器内使用docker</h3><p>两种方案，一种是在Jenkins镜像里就有docker，另一种是使用宿主机的docker。</p>
<p>这里我们采取后者。</p>
<blockquote>
<p>参考 <a target="_blank" rel="noopener" href="https://www.dockone.io/article/431">https://www.dockone.io/article/431</a></p>
</blockquote>
<p>这里只讲操作不讲原因和原理。</p>
<p>第一步修改权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/run</span><br><span class="line">sudo chown root:root docker.sock &amp;&amp; sudo chmod o+rw docker.sock</span><br></pre></td></tr></table></figure>



<p>第二步修改jenkins的docker-compose.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.6&#x27;</span></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">  <span class="attr">jenkins:</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">jenkins/jenkins:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">sdu-weblab-jenkins-latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;18080:8080&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;50000:50000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/var/jenkins_home</span> <span class="comment"># jenkins:latest 的home目录，包括插件和配置等等</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;$MAVEN_HOME:/opt/maven&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;$JAVA_HOME:/opt/java8&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/bin/docker:/usr/bin/docker</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/docker/daemon.json:/etc/docker/daemon.json</span></span><br></pre></td></tr></table></figure>

<p>重点就是挂载宿主机三个文件即可，至于这里为什么mount这三个就足够了，不做解释。</p>
<p>记住重启一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>



<p>检查：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jsy@wzai:~$ docker exec -it a6d580bfb4e1 bash</span><br><span class="line">jenkins@a6d580bfb4e1:/$</span><br><span class="line">jenkins@a6d580bfb4e1:/$</span><br><span class="line">jenkins@a6d580bfb4e1:/$ docker version</span><br></pre></td></tr></table></figure>


<h2 id="Harbor"><a href="#Harbor" class="headerlink" title="Harbor"></a>Harbor</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/goharbor/harbor/releases/download/v2.5.0/harbor-offline-installer-v2.5.0.tgz</span><br></pre></td></tr></table></figure>



<h3 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h3><p><strong>解压</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf harbor-offline-installer-v2.5.0.tgz -C ./</span><br></pre></td></tr></table></figure>

<p>解压结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jsy@wzai:~/devops$ ls harbor/</span><br><span class="line">common.sh  harbor.v2.5.0.tar.gz  harbor.yml.tmpl  install.sh  LICENSE  prepare</span><br></pre></td></tr></table></figure>



<p><strong>编辑配置文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp harbor.yml.tmpl harbor.yml</span><br></pre></td></tr></table></figure>

<p>修改hostname为主机ip，将htts相关内容注释掉（暂时不需要使用到https）、修改admin密码、修改http端口号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hostname: 211.87.224.233</span><br><span class="line"></span><br><span class="line">http:</span><br><span class="line">  # port for http, default is 80. If https enabled, this port will redirect to https port</span><br><span class="line">  port: 8930</span><br><span class="line">  </span><br><span class="line">harbor_admin_password: admin</span><br></pre></td></tr></table></figure>




<p>安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./prepare &amp;&amp; sudo ./install.sh</span><br></pre></td></tr></table></figure>



<p>install过程分为这么几步：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Step 0]: checking if docker is installed ...</span><br><span class="line">[Step 1]: checking docker-compose is installed ...</span><br><span class="line">[Step 2]: loading Harbor images ...</span><br><span class="line">[Step 3]: preparing environment ...</span><br><span class="line">[Step 4]: preparing harbor configs ...</span><br></pre></td></tr></table></figure>



<p>安装完毕后检查一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">jsy@wzai:~/devops/harbor$ sudo docker-compose ps</span><br><span class="line">      Name                    Command                 State                  Ports</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line">harbor-core         /harbor/entrypoint.sh          Up (healthy)</span><br><span class="line">harbor-db           /docker-entrypoint.sh 96 13    Up (healthy)</span><br><span class="line">harbor-jobservice   /harbor/entrypoint.sh          Up (healthy)</span><br><span class="line">harbor-log          /bin/sh -c /usr/local/bin/     Up (healthy)   127.0.0.1:1514-&gt;10514/tcp</span><br><span class="line">                    ...</span><br><span class="line">harbor-portal       nginx -g daemon off;           Up (healthy)</span><br><span class="line">nginx               nginx -g daemon off;           Up (healthy)   0.0.0.0:8930-&gt;8080/tcp,:::89</span><br><span class="line">                                                                  30-&gt;8080/tcp</span><br><span class="line">redis               redis-server /etc/redis.conf   Up (healthy)</span><br><span class="line">registry            /home/harbor/entrypoint.sh     Up (healthy)</span><br><span class="line">registryctl         /home/harbor/start.sh          Up (healthy)</span><br></pre></td></tr></table></figure>



<p>浏览器访问检查</p>
<h3 id="拉取-x2F-推送镜像"><a href="#拉取-x2F-推送镜像" class="headerlink" title="拉取&#x2F;推送镜像"></a>拉取&#x2F;推送镜像</h3><p>下一步使用docker login到私服，需要将私服的htp地址配置到docker的不安全register中；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<p>写入</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;211.87.224.233:8930&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>必须重启docker服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>



<p>镜像名称要求：私服地址&#x2F;项目名&#x2F;镜像名:版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]</span></span><br><span class="line">docker tag IMAGE_ID 私服地址/项目名/镜像名:版本</span><br></pre></td></tr></table></figure>



<p><strong>举例</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag hello-world $HARBOR_URL/sdu-weblab/hello-world # 配置一下HARBOR_URL环境变量</span><br></pre></td></tr></table></figure>

<p>检查一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">docker images</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">211.87.224.233:8930/sdu-weblab/hello-world   latest             feb5d9fea6a5   7 months ago   13.3kB</span></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先登录后推送</span></span><br><span class="line">docker login -u admin -p admin $HARBOR_URL</span><br><span class="line">docker push 211.87.224.233:8930/sdu-weblab/hello-world</span><br></pre></td></tr></table></figure>



<p>推送成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jsy@wzai:~$ docker push 211.87.224.233:8930/sdu-weblab/hello-world</span><br><span class="line">Using default tag: latest</span><br><span class="line">The push refers to repository [211.87.224.233:8930/sdu-weblab/hello-world]</span><br><span class="line">e07ee1baac5f: Pushed</span><br><span class="line">latest: digest: sha256:f54a58bc1aac5ea1a25d796ae155dc228b3f0e11d046ae276b39c4bf2f13d8c4 size: 525</span><br></pre></td></tr></table></figure>



<p>拉取镜像也是一样的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先删除本地的</span></span><br><span class="line">docker image rm 211.87.224.233:8930/sdu-weblab/hello-world</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">直接粘贴浏览器的命令</span></span><br><span class="line">docker pull 211.87.224.233:8930/sdu-weblab/hello-world@sha256:f54a58bc1aac5ea1a25d796ae155dc228b3f0e11d046ae276b39c4bf2f13d8c4</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/jenkinsci/docker/blob/master/README.md">https://github.com/jenkinsci/docker/blob/master/README.md</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/02/linux%E6%9F%A5%E7%9C%8B%E7%A1%AC%E4%BB%B6%E3%80%81%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SongyangJi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JsyBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | JsyBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/02/linux%E6%9F%A5%E7%9C%8B%E7%A1%AC%E4%BB%B6%E3%80%81%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF/" class="post-title-link" itemprop="url">Linux查看硬件、系统信息</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-02 21:00:00" itemprop="dateCreated datePublished" datetime="2022-05-02T21:00:00+08:00">2022-05-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-07 09:38:26" itemprop="dateModified" datetime="2022-11-07T09:38:26+08:00">2022-11-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-查看操作系统"><a href="#1-查看操作系统" class="headerlink" title="1. 查看操作系统"></a>1. 查看操作系统</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsb_release -a</span><br></pre></td></tr></table></figure>



<h1 id="2-查看内存信息"><a href="#2-查看内存信息" class="headerlink" title="2. 查看内存信息"></a>2. 查看内存信息</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/meminfo</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">output</span></span><br><span class="line">MemTotal:        4009020 kB</span><br><span class="line">MemFree:          135628 kB</span><br><span class="line">MemAvailable:    1925688 kB</span><br><span class="line">Buffers:          282728 kB</span><br><span class="line">Cached:          1324092 kB</span><br><span class="line">SwapCached:         1612 kB</span><br><span class="line">Active:           807888 kB</span><br><span class="line">Inactive:        2533284 kB</span><br><span class="line">Active(anon):      43472 kB</span><br><span class="line">Inactive(anon):  1709556 kB</span><br><span class="line">Active(file):     764416 kB</span><br><span class="line">Inactive(file):   823728 kB</span><br><span class="line">Unevictable:        6976 kB</span><br><span class="line">Mlocked:               0 kB</span><br><span class="line">SwapTotal:       2097148 kB</span><br><span class="line">SwapFree:        2052092 kB</span><br><span class="line">Dirty:             16828 kB</span><br><span class="line">Writeback:             0 kB</span><br><span class="line">AnonPages:       1739820 kB</span><br><span class="line">Mapped:           482588 kB</span><br><span class="line">Shmem:             26376 kB</span><br><span class="line">KReclaimable:     385472 kB</span><br><span class="line">Slab:             458420 kB</span><br><span class="line">SReclaimable:     385472 kB</span><br><span class="line">SUnreclaim:        72948 kB</span><br><span class="line">KernelStack:       12944 kB</span><br><span class="line">PageTables:        22444 kB</span><br><span class="line">NFS_Unstable:          0 kB</span><br><span class="line">Bounce:                0 kB</span><br><span class="line">WritebackTmp:          0 kB</span><br><span class="line">CommitLimit:     4101656 kB</span><br><span class="line">Committed_AS:    6306356 kB</span><br><span class="line">VmallocTotal:   133143461888 kB</span><br><span class="line">VmallocUsed:       27320 kB</span><br><span class="line">VmallocChunk:          0 kB</span><br><span class="line">Percpu:             1360 kB</span><br><span class="line">HardwareCorrupted:     0 kB</span><br><span class="line">AnonHugePages:         0 kB</span><br><span class="line">ShmemHugePages:        0 kB</span><br><span class="line">ShmemPmdMapped:        0 kB</span><br><span class="line">FileHugePages:         0 kB</span><br><span class="line">FilePmdMapped:         0 kB</span><br><span class="line">CmaTotal:          32768 kB</span><br><span class="line">CmaFree:           30140 kB</span><br><span class="line">HugePages_Total:       0</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line">Hugetlb:               0 kB</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认</span></span><br><span class="line">free</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">              总计         已用        空闲      共享    缓冲/缓存    可用</span><br><span class="line">内存：     4009020     1889432      115696       26380     2003892     1917212</span><br><span class="line">交换：     2097148       46848     2050300</span><br></pre></td></tr></table></figure>



<h1 id="3-查看CPU信息"><a href="#3-查看CPU信息" class="headerlink" title="3. 查看CPU信息"></a>3. 查看CPU信息</h1><p>总核数 &#x3D; 物理CPU个数 X 每颗物理CPU的核数<br>总逻辑CPU数 &#x3D; 物理CPU个数 X 每颗物理CPU的核数 X 超线程数</p>
<p>查看物理CPU个数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cpuinfo | grep &quot;physical id&quot; | sort | uniq | wc -l</span><br></pre></td></tr></table></figure>

<p>查看每个物理CPU中core的个数(即核数)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cpuinfo | grep &quot;cpu cores&quot; | uniq</span><br></pre></td></tr></table></figure>

<p>查看逻辑CPU的个数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cpuinfo | grep &quot;processor&quot; | wc -l</span><br></pre></td></tr></table></figure>

<p>查看CPU信息（型号）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c</span><br></pre></td></tr></table></figure>



<h1 id="4-查看CPU的负载"><a href="#4-查看CPU的负载" class="headerlink" title="4. 查看CPU的负载"></a>4. 查看CPU的负载</h1><p>平均负载是指上一分钟同时处于就绪状态的平均进程数。</p>
<p>如果CPU Load等于CPU个数乘以核数，那么就说CPU正好满负载，再多一点，可能就要出问题了，有些任务不能被及时分配处理器，那要保证响应时间的话，最好要小于CPU个数X核数X0.7。</p>
<p>Load Average是指CPU的Load。它所包含的信息是在一段时间内CPU正在处理及等待CPU处理的进程数之和的统计信息，也就是CPU使用队列的长度的统计信息。<br>Load Average的值应该小于CPU个数X核数X0.7，<br>Load Average会有3个状态平均值，分别是1分钟、5分钟和15分钟平均Load。</p>
<p>如果1分钟平均出现大于CPU个数X核数的情况，还不需要担心；如果5分钟的平均也是这样，那就要警惕了；15分钟的平均也是这样，就要分析哪里出现问题，防范未然。<br>查看CPU负载信息，使用<code>top</code>命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">output</span></span><br><span class="line">top - 15:50:31 up 4 days, 23:43, 1 user, load average: 0.51, 0.29, 0.37</span><br><span class="line">Tasks: 492 total,  1 running, 490 sleeping,  1 stopped,  0 zombie</span><br><span class="line">Cpu(s): 6.4%us, 0.1%sy, 0.0%ni, 93.4%id, 0.1%wa, 0.0%hi, 0.0%si, 0.0%st</span><br><span class="line">Mem: 65973912k total, 32468632k used, 33505280k free,  906712k buffers</span><br><span class="line">Swap: 41943032k total,  13204k used, 41929828k free, 6434448k cached</span><br></pre></td></tr></table></figure>


<blockquote>
<p> MacOS查看信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top -l 1 | head -n 10</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="5-硬盘"><a href="#5-硬盘" class="headerlink" title="5. 硬盘"></a>5. 硬盘</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fdisk -l</span><br><span class="line">fdisk -l |grep Disk</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">output</span></span><br><span class="line">Disk /dev/sda: 500.1 GB, 500107862016 bytes</span><br><span class="line">255 heads, 63 sectors/track, 60801 cylinders, total 976773168 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 4096 bytes</span><br><span class="line">I/O size (minimum/optimal): 4096 bytes / 4096 bytes</span><br><span class="line">Disk identifier: 0x00023728</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048     2148351     1073152   83  Linux</span><br><span class="line">/dev/sda2         2148352    21680127     9765888   82  Linux swap / Solaris</span><br><span class="line">/dev/sda3        21680128   177930239    78125056   83  Linux</span><br><span class="line">/dev/sda4       177932286   976771071   399419393    5  Extended/dev/sda5       177932288   412305407   117186560   83  Linux</span><br><span class="line">/dev/sda6       412307456   976771071   282231808   83  Linux</span><br></pre></td></tr></table></figure>





<blockquote>
<p> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/ggjucheng/archive/2013/01/14/2859613.html">https://www.cnblogs.com/ggjucheng/archive/2013/01/14/2859613.html</a></p>
</blockquote>
<p> 补：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">uname -a # 查看内核/操作系统/CPU信息(含x86_64表示32位机器,i686表示32位机器)</span><br><span class="line">head -n 1 /etc/issue # 查看操作系统版本，是数字1不是字母L</span><br><span class="line">cat /proc/cpuinfo # 查看CPU信息的linux系统信息命令</span><br><span class="line">hostname # 查看计算机名的linux系统信息命令</span><br><span class="line">lspci -tv # 列出所有PCI设备</span><br><span class="line">lsusb -tv # 列出所有USB设备的linux系统信息命令</span><br><span class="line">lsmod # 列出加载的内核模块</span><br><span class="line">env # 查看环境变量资源</span><br><span class="line">free -m # 查看内存使用量和交换区使用量</span><br><span class="line">df -h # 查看各分区使用情况</span><br><span class="line">du -sh # 查看指定目录的大小</span><br><span class="line">grep MemTotal /proc/meminfo # 查看内存总量</span><br><span class="line">grep MemFree /proc/meminfo # 查看空闲内存量</span><br><span class="line">uptime # 查看系统运行时间、用户数、负载</span><br><span class="line">cat /proc/loadavg # 查看系统负载磁盘和分区</span><br><span class="line">mount | column -t # 查看挂接的分区状态</span><br><span class="line">fdisk -l # 查看所有分区</span><br><span class="line">swapon -s # 查看所有交换分区</span><br><span class="line">hdparm -i /dev/hda # 查看磁盘参数(仅适用于IDE设备)</span><br><span class="line">dmesg | grep IDE # 查看启动时IDE设备检测状况网络</span><br><span class="line">ifconfig # 查看所有网络接口的属性</span><br><span class="line">iptables -L # 查看防火墙设置</span><br><span class="line">route -n # 查看路由表</span><br><span class="line">netstat -lntp # 查看所有监听端口</span><br><span class="line">netstat -antp # 查看所有已经建立的连接</span><br><span class="line">netstat -s # 查看网络统计信息进程</span><br><span class="line">ps -ef # 查看所有进程</span><br><span class="line">top # 实时显示进程状态用户</span><br><span class="line">w # 查看活动用户</span><br><span class="line">id # 查看指定用户信息</span><br><span class="line">last # 查看用户登录日志</span><br><span class="line">cut -d: -f1 /etc/passwd # 查看系统所有用户</span><br><span class="line">cut -d: -f1 /etc/group # 查看系统所有组</span><br><span class="line">crontab -l # 查看当前用户的计划任务服务</span><br><span class="line">chkconfig –list # 列出所有系统服务</span><br><span class="line">chkconfig –list | grep on # 列出所有启动的系统服务程序</span><br><span class="line">rpm -qa # 查看所有安装的软件包</span><br><span class="line">cat /proc/cpuinfo ：查看CPU相关参数的linux系统命令</span><br><span class="line">cat /proc/partitions ：查看linux硬盘和分区信息的系统信息命令</span><br><span class="line">cat /proc/meminfo ：查看linux系统内存信息的linux系统命令</span><br><span class="line">cat /proc/version ：查看版本，类似uname -r</span><br><span class="line">cat /proc/ioports ：查看设备io端口</span><br><span class="line">cat /proc/interrupts ：查看中断</span><br><span class="line">cat /proc/pci ：查看pci设备的信息</span><br><span class="line">cat /proc/swaps ：查看所有swap分区的信息 </span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/02/ssh%E5%85%AC%E9%92%A5%E7%A7%81%E9%92%A5%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SongyangJi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JsyBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | JsyBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/02/ssh%E5%85%AC%E9%92%A5%E7%A7%81%E9%92%A5%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">ssh公钥私钥原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-02 11:12:14 / 修改时间：15:51:03" itemprop="dateCreated datePublished" datetime="2022-05-02T11:12:14+08:00">2022-05-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">计算机网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ssh公钥私钥原理"><a href="#ssh公钥私钥原理" class="headerlink" title="ssh公钥私钥原理"></a>ssh公钥私钥原理</h1><p>主要有两种登录方式：第一种为密码口令登录，第二种为公钥登录</p>
<h2 id="一、密码登录"><a href="#一、密码登录" class="headerlink" title="一、密码登录"></a>一、密码登录</h2><p>整个过程是这样的：</p>
<ol>
<li><p>远程主机收到用户的登录请求，把自己的公钥发给用户。</p>
</li>
<li><p>用户使用这个公钥，将登录密码加密后，发送到远程主机。（客户端输入密码的过程）</p>
</li>
<li><p>远程主机用自己的私钥，解密登录密码，如果密码正确，就同意用户登录。</p>
</li>
</ol>
<p>这个过程本身是安全的，但是实施的时候存在一个风险：<strong>如果有人截获了登录请求，然后冒充远程主机，将伪造的公钥发给用户，那么用户很难辨别真伪。因为不像https协议，SSH协议的公钥是没有证书中心（CA）公证的，也就是说，都是自己签发的。</strong></p>
<p>如果你是第一次登录对方主机，系统会出现下面的提示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">　$ </span><span class="language-bash">``ssh` `user@host` `The authenticity of host ``<span class="string">&#x27;host (12.18.429.21)&#x27;</span>` `can<span class="string">&#x27;t be established.` `RSA key fingerprint is 98:2e:d7:e0:de:9f:ac:67:28:c2:42:2d:37:16:58:4d.` `Are you sure you want to ``continue` `connecting (``yes``/no``)?</span></span></span><br></pre></td></tr></table></figure>

<p>这段话的意思是，无法确认host主机的真实性，只知道它的公钥指纹，问你还想继续连接吗？</p>
<p>所谓<strong>公钥指纹</strong>，是指公钥长度较长（这里采用RSA算法，长达1024位），很难比对，所以对其进行MD5计算，将它变成一个128位的指纹。上例中是<code>98:2e:d7:e0:de:9f:ac:67:28:c2:42:2d:37:16:58:4d</code>，再进行比较，就容易多了。</p>
<p>很自然的一个问题就是，用户怎么知道远程主机的公钥指纹应该是多少？回答是没有好办法，<strong>远程主机必须在自己的网站上贴出公钥指纹，以便用户自行核对。假定经过风险衡量以后，用户决定接受这个远程主机的公钥。</strong></p>
<p>当远程主机的公钥被接受以后，它就会被保存在文件<code>$HOME/.ssh/known_hosts</code>之中。下次再连接这台主机，系统就会认出它的公钥已经保存在本地了，从而跳过警告部分，直接提示输入密码。</p>
<p>每个SSH用户都有自己的known_hosts文件，此外系统也有一个这样的文件，通常是&#x2F;etc&#x2F;ssh&#x2F;ssh_known_hosts，保存一些对所有用户都可信赖的远程主机的公钥。</p>
<h2 id="二、公钥登录"><a href="#二、公钥登录" class="headerlink" title="二、公钥登录"></a>二、公钥登录</h2><p><strong>公钥登录是为了解决每次登录服务器都要输入密码的问题，流行使用RSA加密方案</strong>，主要流程包含：</p>
<ol>
<li>客户端生成RSA公钥和私钥（其实在哪生成是无所谓的）</li>
<li>客户端将自己的公钥存放到服务器（如果是服务端生成，则将）</li>
<li>客户端请求连接服务器，服务器将一个随机字符串发送给客户端（发送一个随机串）</li>
<li>客户端根据自己的私钥加密这个随机字符串之后再发送给服务器（客户端私钥加密）</li>
<li>服务器接受到加密后的字符串之后用公钥解密，如果正确就让客户端登录，否则拒绝。这样就不用使用密码了。</li>
</ol>
<p><img src="/ssh%E5%85%AC%E9%92%A5%E7%A7%81%E9%92%A5%E5%8E%9F%E7%90%86/ssh%E5%85%AC%E9%92%A5%E7%A7%81%E9%92%A5%E5%8E%9F%E7%90%861.png" alt="img"></p>
<h3 id="公钥和私钥"><a href="#公钥和私钥" class="headerlink" title="公钥和私钥"></a>公钥和私钥</h3><p>一个公钥对应一个私钥。密钥对中，让大家都知道的是公钥，不告诉大家，只有自己知道的，是私钥。</p>
<ol>
<li>私钥用来进行解密和签名，是给自己用的。</li>
<li>公钥由本人公开，用于加密和验证签名，是给别人用的。</li>
<li>当该用户发送信息时，用私钥签名，别人用他给的公钥验证签名，可以保证该信息是由自己发送的（保证信息的不可篡改）；当该用户接受信息时，别人用他的公钥加密，他用私钥解密，可以保证该信息只能由他接收到（保证信息的私密性）。</li>
</ol>
<h3 id="RSA算法的作用"><a href="#RSA算法的作用" class="headerlink" title="RSA算法的作用"></a>RSA算法的作用</h3><h4 id="1、加密：公钥加密私钥解密"><a href="#1、加密：公钥加密私钥解密" class="headerlink" title="1、加密：公钥加密私钥解密"></a>1、加密：公钥加密私钥解密</h4><p>　　<strong>主要用于将数据资料加密不被其他人非法获取，保证数据私密性。</strong>使用公钥将数据资料加密，只有私钥可以解密。即使密文在网络上被第三方获取由于没有私钥则无法解密。从而保证数据安全性。　　　　　</p>
<ol>
<li>A在自己电脑上生成RSA钥匙文件，一个私钥文件一个公钥文件，并将他的公钥传送给B；</li>
<li>此时B要传送信息给A，于是B用A的公钥加密他的消息，然后传送给A。【网络上传输的密文，没有A的私钥无法解密，其他人获取之后也没用】；</li>
<li>A用他的私钥解密B的消息。</li>
</ol>
<h4 id="2、认证：私钥加密公钥解密"><a href="#2、认证：私钥加密公钥解密" class="headerlink" title="2、认证：私钥加密公钥解密"></a>2、认证：私钥加密公钥解密</h4><p>主要用于身份验证，判断某个身份的真实性。<strong>使用私钥加密之后，用对应的公钥解密从而验证身份真实性。</strong></p>
<p>比如【服务端S】要验证【客户端C】是否是真实用户：</p>
<ol>
<li>C将自己公钥给S；</li>
<li>C将信息用自己私钥加密传送给S；</li>
<li>S根据C的公钥解密，如果成功则为真实身份用户。</li>
</ol>
<p><strong>SSH公钥登录则用的是第二种功能。</strong></p>
<blockquote>
<p>安全性： 这种算法非常可靠，密钥越长，它就越难破解。根据已经披露的文献，目前被破解的最长RSA密钥是768个二进制位。也就是说，长度超过768位的密钥，还无法破解（至少没人公开宣布）。因此可以认为，1024位的RSA密钥基本安全，2048位的密钥极其安全。所以我们在用ssh-keygen命令时候要注意密钥长度，具体参数为：<code>-b bits</code>（指定密钥长度。对于RSA密钥，最小要求768位，默认是2048位。DSA密钥必须恰好是1024位(FIPS 186-2 标准的要求)。）<br>至少不能少于768。一般不用写默认就是2048了。</p>
</blockquote>
<p>注意：ssh 和 https 协议的区别，ssh 没有CA认证中心的概念。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/26/ulimit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SongyangJi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JsyBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | JsyBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/26/ulimit/" class="post-title-link" itemprop="url">ulimit</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-04-26 21:29:48 / 修改时间：21:47:03" itemprop="dateCreated datePublished" datetime="2022-04-26T21:29:48+08:00">2022-04-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ulimit"><a href="#ulimit" class="headerlink" title="ulimit"></a>ulimit</h1><p>  系统性能一直是一个受关注的话题，如何通过最简单的设置来实现最有效的性能调优，如何在有限资源的条件下保证程序的运作，ulimit 是我们在处理这些问题时，经常使用的一种<strong>简单手段</strong>。ulimit 是一种 Linux 系统的内键功能，它具有一套参数集，用于为由<strong>它生成的 shell进程及其子进程</strong>的资源使用设置限制。</p>
<h2 id="ulimit命令"><a href="#ulimit命令" class="headerlink" title="ulimit命令"></a>ulimit命令</h2><p>ulimit 通过一些参数选项来管理不同种类的系统资源。<br>ulimit 命令的格式为：ulimit [options] [limit]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">选项 含义</span><br><span class="line"> </span><br><span class="line">-a 显示当前系统所有的limit资源信息。 </span><br><span class="line"> </span><br><span class="line">-H 设置硬资源限制，一旦设置不能增加。例如：ulimit – Hs 64；限制硬资源，线程栈大小为 64K。</span><br><span class="line"> </span><br><span class="line">-S 设置软资源限制，设置后可以增加，但是不能超过硬资源设置。例如：ulimit – Sn 32；限制软资源，32 个文件描述符。</span><br><span class="line"> </span><br><span class="line">-c 最大的core文件的大小，以 blocks 为单位。例如：ulimit – c unlimited； 对生成的 core 文件的大小不进行限制。</span><br><span class="line"> </span><br><span class="line">-f 进程可以创建文件的最大值，以blocks 为单位.例如：ulimit – f 2048；限制进程可以创建的最大文件大小为 2048 blocks。</span><br><span class="line"> </span><br><span class="line">-d 进程最大的数据段的大小，以Kbytes 为单位。例如：ulimit -d unlimited；对进程的数据段大小不进行限制。</span><br><span class="line"> </span><br><span class="line">-m 最大内存大小，以Kbytes为单位。例如：ulimit – m unlimited；对最大内存不进行限制。</span><br><span class="line"> </span><br><span class="line">-n 可以打开的最大文件描述符的数量。例如：ulimit – n 128；限制最大可以使用 128 个文件描述符</span><br><span class="line"> </span><br><span class="line">-s 线程栈大小，以Kbytes为单位。例如:ulimit – s 512；限制线程栈的大小为 512 Kbytes。</span><br><span class="line"> </span><br><span class="line">-p 管道缓冲区的大小，以Kbytes 为单位。例如ulimit – p 512；限制管道缓冲区的大小为 512 Kbytes。</span><br><span class="line"> </span><br><span class="line">-u 用户最大可用的进程数。例如 limit – u 65536；限制用户最多可以使用 65536个进程。</span><br><span class="line"> </span><br><span class="line">-v 进程最大可用的虚拟内存，以Kbytes 为单位。ulimit – v 200000；限制最大可用的虚拟内存为 200000 Kbytes。</span><br><span class="line"> </span><br><span class="line">-t 最大CPU占用时间，以秒为单位。ulimit – t unlimited；对最大的 CPU 占用时间不进行限制。</span><br><span class="line"> </span><br><span class="line">-l 最大可加锁内存大小，以Kbytes 为单位。</span><br></pre></td></tr></table></figure>

<h2 id="使用ulimit的几种方案"><a href="#使用ulimit的几种方案" class="headerlink" title="使用ulimit的几种方案"></a>使用ulimit的几种方案</h2><h3 id="在用户的启动脚本中"><a href="#在用户的启动脚本中" class="headerlink" title="在用户的启动脚本中"></a>在用户的启动脚本中</h3><pre><code>    如果用户使用的是 bash，就可以在用户的目录下的 .bashrc 文件中，加入 ulimit – u 64，来限制用户最多可以使用 64 个进程。此外，可以在与 .bashrc 功能相当的启动脚本中加入 ulimt。
</code></pre>
<h3 id="在应用程序的启动脚本中"><a href="#在应用程序的启动脚本中" class="headerlink" title="在应用程序的启动脚本中"></a>在应用程序的启动脚本中</h3><p>如果用户要对某个应用程序 myapp 进行限制，可以写一个简单的脚本 startmyapp。</p>
<p>ulimit – s 512<br>myapp</p>
<p>以后只要通过脚本 startmyapp 来启动应用程序，就可以限制应用程序 myapp 的线程栈大小为 512K。</p>
<h3 id="直接在控制台输入"><a href="#直接在控制台输入" class="headerlink" title="直接在控制台输入"></a>直接在控制台输入</h3><p>ulimit – p 256 </p>
<p>限制管道的缓冲区为 256K。</p>
<h3 id="修改所有-linux-用户的环境变量文件："><a href="#修改所有-linux-用户的环境变量文件：" class="headerlink" title="修改所有 linux 用户的环境变量文件："></a>修改所有 linux 用户的环境变量文件：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">ulimit -u 10000</span><br><span class="line"></span><br><span class="line">ulimit -n 4096</span><br><span class="line"></span><br><span class="line">ulimit -d unlimited</span><br><span class="line"></span><br><span class="line">ulimit -m unlimited</span><br><span class="line"></span><br><span class="line">ulimit -s unlimited</span><br><span class="line"></span><br><span class="line">ulimit -t unlimited</span><br><span class="line"></span><br><span class="line">ulimit -v unlimited</span><br></pre></td></tr></table></figure>
<p> 保存后运行#source &#x2F;etc&#x2F;profile 使其生效</p>
<h3 id="也可以针对单个用户的-bash-profile设置："><a href="#也可以针对单个用户的-bash-profile设置：" class="headerlink" title="也可以针对单个用户的.bash_profile设置："></a>也可以针对单个用户的.bash_profile设置：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi ~./.bash_profile</span><br><span class="line"></span><br><span class="line">ulimit -n 1024</span><br></pre></td></tr></table></figure>
<p>重新登陆ok</p>
<h2 id="限制资源的作用范围"><a href="#限制资源的作用范围" class="headerlink" title="限制资源的作用范围"></a>限制资源的作用范围</h2><p>ulimit 作为对资源使用限制的一种工作，是有其作用范围的。那么，它限制的对象是单个用户，单个进程，还是整个系统呢？事实上，ulimit 限制的是当前 shell 进程以及其派生的子进程。举例来说，如果用户同时运行了两个 shell 终端进程，只在其中一个环境中执行了 ulimit – s 100，则该 shell 进程里创建文件的大小收到相应的限制，而同时另一个 shell终端包括其上运行的子程序都不会受其影响。</p>
<h3 id="针对用户永久生效"><a href="#针对用户永久生效" class="headerlink" title="针对用户永久生效"></a>针对用户永久生效</h3><p>那么，是否有针对某个具体用户的资源加以限制的方法呢？答案是有的，方法是通过修改系统的 &#x2F;etc&#x2F;security&#x2F;limits.conf配置文件。该文件不仅能限制指定用户的资源使用，还能限制指定组的资源使用。该文件的每一行都是对限定的一个描述。<br>imits.conf的格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;domain&gt;                  &lt;type&gt;      &lt;item&gt;     &lt;value&gt; </span><br><span class="line">username|@groupname       type        resource          limit</span><br></pre></td></tr></table></figure>
<p>domain：username|@groupname：设置需要被限制的用户名，组名前面加@和用户名区别。也可以用通配符*来做所有用户的限制。</p>
<p>type：有 soft，hard 和 -，soft 指的是当前系统生效的设置值。hard 表明系统中所能设定的最大值。soft 的最大值不能超过hard的值。用 – 就表明同时设置了 soft 和 hard 的值。</p>
<p>resource：<br>    core – 限制内核文件的大小<br>    date – 最大数据大小<br>    fsize – 最大文件大小<br>    memlock – 最大锁定内存地址空间<br>    nofile – 打开文件的最大数目<br>    rss – 最大持久设置大小<br>    stack – 最大栈大小<br>    cpu – 以分钟为单位的最多 CPU 时间<br>    noproc – 进程的最大数目（系统的最大进程数）<br>    as – 地址空间限制<br>    maxlogins – 此用户允许登录的最大数目<br>要使 limits.conf 文件配置生效，必须要确保 pam_limits.so 文件被加入到启动文件中。<br>查看 &#x2F;etc&#x2F;pam.d&#x2F;login 文件中有：session required &#x2F;lib&#x2F;security&#x2F;pam_limits.so</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/9/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/11/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SongyangJi</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
